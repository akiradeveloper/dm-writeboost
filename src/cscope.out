cscope 15 $HOME/src/dm-writeboost/Driver               0000073125
	@dm-writeboost-daemon.c

7 
	~"dm-wr™eboo¡.h
"

8 
	~"dm-wr™eboo¡-m‘ad©a.h
"

9 
	~"dm-wr™eboo¡-d«mÚ.h
"

13 
	$upd©e_b¬r›r_d—dlše
(
wb_deviû
 *
wb
)

15 
	`mod_tim”
(&
wb
->
b¬r›r_d—dlše_tim”
,

16 
jiff›s
 + 
	`m£cs_to_jiff›s
(
	`ACCESS_ONCE
(
wb
->
b¬r›r_d—dlše_ms
)));

17 
	}
}

19 
	$queue_b¬r›r_io
(
wb_deviû
 *
wb
, 
bio
 *bio)

21 
	`mu‹x_lock
(&
wb
->
io_lock
);

22 
	`bio_li¡_add
(&
wb
->
b¬r›r_ios
, 
bio
);

23 
	`mu‹x_uÆock
(&
wb
->
io_lock
);

25 ià(!
	`tim”_³ndšg
(&
wb
->
b¬r›r_d—dlše_tim”
))

26 
	`upd©e_b¬r›r_d—dlše
(
wb
);

27 
	}
}

29 
	$b¬r›r_d—dlše_´oc
(
d©a
)

31 
wb_deviû
 *
wb
 = (wb_deviû *è
d©a
;

32 
	`scheduË_wÜk
(&
wb
->
b¬r›r_d—dlše_wÜk
);

33 
	}
}

35 
	$æush_b¬r›r_ios
(
wÜk_¡ruù
 *
wÜk
)

37 
wb_deviû
 *
wb
 = 
	`cÚš”_of
(

38 
wÜk
, 
wb_deviû
, 
b¬r›r_d—dlše_wÜk
);

40 ià(
	`bio_li¡_em±y
(&
wb
->
b¬r›r_ios
))

43 
	`©omic64_šc
(&
wb
->
couÁ_nÚ_fuÎ_æushed
);

44 
	`æush_cu¼’t_bufãr
(
wb
);

45 
	}
}

50 
	$´oûss_deã¼ed_b¬r›rs
(
wb_deviû
 *
wb
, 
æush_job
 *
job
)

52 
r
 = 0;

53 
boŞ
 
has_b¬r›r
 = !
	`bio_li¡_em±y
(&
job
->
b¬r›r_ios
);

58 ià(
has_b¬r›r
)

59 
	`IO
(
	`blkdev_issue_æush
(
wb
->
ÿche_dev
->
bdev
, 
GFP_NOIO
, 
NULL
));

64 ià(
has_b¬r›r
) {

65 
bio
 *bio;

66 (
bio
 = 
	`bio_li¡_pİ
(&
job
->
b¬r›r_ios
))) {

67 
	`LIVE_DEAD
(

68 
	`bio_’dio
(
bio
, 0),

69 
	`bio_’dio
(
bio
, -
EIO
)

74 ià(
has_b¬r›r
)

75 
	`upd©e_b¬r›r_d—dlše
(
wb
);

76 
	}
}

78 
	$æush_´oc
(
wÜk_¡ruù
 *
wÜk
)

80 
r
 = 0;

82 
æush_job
 *
job
 = 
	`cÚš”_of
(
wÜk
, flush_job, work);

84 
wb_deviû
 *
wb
 = 
job
->wb;

85 
£gm’t_h—d”
 *
£g
 = 
job
->seg;

87 
dm_io_»que¡
 
io_»q
 = {

88 .
ş›Á
 = 
wb_io_ş›Á
,

89 .
bi_rw
 = 
WRITE
,

90 .
nÙify
.
â
 = 
NULL
,

91 .
mem
.
ty³
 = 
DM_IO_KMEM
,

92 .
mem
.
±r
.
addr
 = 
job
->
¿mbuf
->
d©a
,

94 
dm_io_»giÚ
 
»giÚ
 = {

95 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

96 .
£ùÜ
 = 
£g
->
¡¬t_£ùÜ
,

97 .
couÁ
 = (
£g
->
Ëngth
 + 1) << 3,

104 
	`IO
(
	`dm_§ã_io
(&
io_»q
, 1, &
»giÚ
, 
NULL
, 
çl£
));

111 
	`wa™_fÜ_æushšg
(
wb
, 
	`SUB_ID
(
£g
->
id
, 1));

113 
	`´oûss_deã¼ed_b¬r›rs
(
wb
, 
job
);

119 
	`©omic64_šc
(&
wb
->
Ï¡_æushed_£gm’t_id
);

120 
	`wake_up_š‹¼u±ibË
(&
wb
->
æush_wa™_queue
);

122 
	`mempoŞ_ä“
(
job
, 
wb
->
æush_job_poŞ
);

123 
	}
}

125 
	$wa™_fÜ_æushšg
(
wb_deviû
 *
wb
, 
u64
 
id
)

127 
	`wa™_ev’t_š‹¼u±ibË
(
wb
->
æush_wa™_queue
,

128 
	`©omic64_»ad
(&
wb
->
Ï¡_æushed_£gm’t_id
è>ğ
id
);

129 
	}
}

133 
	$mig¿‹_’dio
(
”rÜ
, *
cÚ‹xt
)

135 
wb_deviû
 *
wb
 = 
cÚ‹xt
;

137 ià(
”rÜ
)

138 
	`©omic_šc
(&
wb
->
mig¿‹_ç_couÁ
);

140 ià(
	`©omic_dec_ªd_‹¡
(&
wb
->
mig¿‹_io_couÁ
))

141 
	`wake_up_š‹¼u±ibË
(&
wb
->
mig¿‹_io_wa™_queue
);

142 
	}
}

150 
	$subm™_mig¿‹_io
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
,

151 
size_t
 
k
)

153 
r
 = 0;

154 
u8
 
i
, 
j
;

156 
size_t
 
a
 = 
wb
->
Ä_ÿches_š£g
 * 
k
;

157 *
p
 = 
wb
->
mig¿‹_bufãr
 + (wb->
Ä_ÿches_š£g
 << 12è* 
k
;

159 
i
 = 0; i < 
£g
->
Ëngth
; i++) {

160 
off£t
;

161 *
ba£
, *
addr
;

162 
dm_io_»que¡
 
io_»q_w
;

163 
dm_io_»giÚ
 
»giÚ_w
;

165 
m‘ablock
 *
mb
 = 
£g
->
mb_¬¿y
 + 
i
;

166 
u8
 
dœty_b™s
 = *(
wb
->
dœtšess_¢­shÙ
 + (
a
 + 
i
));

168 ià(!
dœty_b™s
)

171 
off£t
 = 
i
 << 12;

172 
ba£
 = 
p
 + 
off£t
;

174 ià(
dœty_b™s
 == 255) {

175 
addr
 = 
ba£
;

176 
io_»q_w
 = (
dm_io_»que¡
) {

177 .
ş›Á
 = 
wb_io_ş›Á
,

178 .
bi_rw
 = 
WRITE
,

179 .
nÙify
.
â
 = 
mig¿‹_’dio
,

180 .
nÙify
.
cÚ‹xt
 = 
wb
,

181 .
mem
.
ty³
 = 
DM_IO_VMA
,

182 .
mem
.
±r
.
vma
 = 
addr
,

184 
»giÚ_w
 = (
dm_io_»giÚ
) {

185 .
bdev
 = 
wb
->
Üigš_dev
->bdev,

186 .
£ùÜ
 = 
mb
->sector,

187 .
couÁ
 = 1 << 3,

189 
	`IO
(
	`dm_§ã_io
(&
io_»q_w
, 1, &
»giÚ_w
, 
NULL
, 
çl£
));

191 
j
 = 0; j < 8; j++) {

192 
boŞ
 
b
 = 
dœty_b™s
 & (1 << 
j
);

193 ià(!
b
)

196 
addr
 = 
ba£
 + (
j
 << 
SECTOR_SHIFT
);

197 
io_»q_w
 = (
dm_io_»que¡
) {

198 .
ş›Á
 = 
wb_io_ş›Á
,

199 .
bi_rw
 = 
WRITE
,

200 .
nÙify
.
â
 = 
mig¿‹_’dio
,

201 .
nÙify
.
cÚ‹xt
 = 
wb
,

202 .
mem
.
ty³
 = 
DM_IO_VMA
,

203 .
mem
.
±r
.
vma
 = 
addr
,

205 
»giÚ_w
 = (
dm_io_»giÚ
) {

206 .
bdev
 = 
wb
->
Üigš_dev
->bdev,

207 .
£ùÜ
 = 
mb
->£ùÜ + 
j
,

208 .
couÁ
 = 1,

210 
	`IO
(
	`dm_§ã_io
(&
io_»q_w
, 1, &
»giÚ_w
, 
NULL
, 
çl£
));

214 
	}
}

216 
	$memÜize_d©a_to_mig¿‹
(
wb_deviû
 *
wb
,

217 
£gm’t_h—d”
 *
£g
, 
size_t
 
k
)

219 
r
 = 0;

221 *
p
 = 
wb
->
mig¿‹_bufãr
 + (wb->
Ä_ÿches_š£g
 << 12è* 
k
;

222 
dm_io_»que¡
 
io_»q_r
 = {

223 .
ş›Á
 = 
wb_io_ş›Á
,

224 .
bi_rw
 = 
READ
,

225 .
nÙify
.
â
 = 
NULL
,

226 .
mem
.
ty³
 = 
DM_IO_VMA
,

227 .
mem
.
±r
.
vma
 = 
p
,

229 
dm_io_»giÚ
 
»giÚ_r
 = {

230 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

231 .
£ùÜ
 = 
£g
->
¡¬t_£ùÜ
 + (1 << 3),

232 .
couÁ
 = 
£g
->
Ëngth
 << 3,

234 
	`IO
(
	`dm_§ã_io
(&
io_»q_r
, 1, &
»giÚ_r
, 
NULL
, 
çl£
));

235 
	}
}

244 
	$memÜize_m‘ad©a_to_mig¿‹
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
,

245 
size_t
 
k
, size_ˆ*
mig¿‹_io_couÁ
)

247 
u8
 
i
, 
j
;

249 
m‘ablock
 *
mb
;

250 
size_t
 
a
 = 
wb
->
Ä_ÿches_š£g
 * 
k
;

257 
i
 = 0; i < 
£g
->
Ëngth
; i++) {

258 
mb
 = 
£g
->
mb_¬¿y
 + 
i
;

259 *(
wb
->
dœtšess_¢­shÙ
 + (
a
 + 
i
)èğ
	`»ad_mb_dœtšess
(wb, 
£g
, 
mb
);

262 
i
 = 0; i < 
£g
->
Ëngth
; i++) {

263 
u8
 
dœty_b™s
 = *(
wb
->
dœtšess_¢­shÙ
 + (
a
 + 
i
));

265 ià(!
dœty_b™s
)

268 ià(
dœty_b™s
 == 255) {

269 (*
mig¿‹_io_couÁ
)++;

271 
j
 = 0; j < 8; j++) {

272 ià(
dœty_b™s
 & (1 << 
j
))

273 (*
mig¿‹_io_couÁ
)++;

277 
	}
}

282 
	$memÜize_dœty_¡©e
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
,

283 
size_t
 
k
, size_ˆ*
mig¿‹_io_couÁ
)

285 
	`memÜize_d©a_to_mig¿‹
(
wb
, 
£g
, 
k
);

286 
	`memÜize_m‘ad©a_to_mig¿‹
(
wb
, 
£g
, 
k
, 
mig¿‹_io_couÁ
);

287 
	}
}

289 
	$ş—nup_£gm’t
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
)

291 
u8
 
i
;

292 
i
 = 0; i < 
£g
->
Ëngth
; i++) {

293 
m‘ablock
 *
mb
 = 
£g
->
mb_¬¿y
 + 
i
;

294 
	`ş—nup_mb_if_dœty
(
wb
, 
£g
, 
mb
);

296 
	}
}

298 
	$Œª¥Üt_emig¿‹s
(
wb_deviû
 *
wb
)

300 
r
;

301 
£gm’t_h—d”
 *
£g
;

302 
size_t
 
k
, 
mig¿‹_io_couÁ
 = 0;

304 
k
 = 0; k < 
wb
->
num_emig¿‹s
; k++) {

305 
£g
 = *(
wb
->
emig¿‹s
 + 
k
);

306 
	`memÜize_dœty_¡©e
(
wb
, 
£g
, 
k
, &
mig¿‹_io_couÁ
);

309 
mig¿‹_wr™e
:

310 
	`©omic_£t
(&
wb
->
mig¿‹_io_couÁ
, migrate_io_count);

311 
	`©omic_£t
(&
wb
->
mig¿‹_ç_couÁ
, 0);

313 
k
 = 0; k < 
wb
->
num_emig¿‹s
; k++) {

314 
£g
 = *(
wb
->
emig¿‹s
 + 
k
);

315 
	`subm™_mig¿‹_io
(
wb
, 
£g
, 
k
);

318 
	`LIVE_DEAD
(

319 
	`wa™_ev’t_š‹¼u±ibË
(
wb
->
mig¿‹_io_wa™_queue
,

320 !
	`©omic_»ad
(&
wb
->
mig¿‹_io_couÁ
)),

321 
	`©omic_£t
(&
wb
->
mig¿‹_io_couÁ
, 0));

323 ià(
	`©omic_»ad
(&
wb
->
mig¿‹_ç_couÁ
)) {

324 
	`WBWARN
("%u writebacks failed.„etry",

325 
	`©omic_»ad
(&
wb
->
mig¿‹_ç_couÁ
));

326 
mig¿‹_wr™e
;

328 
	`BUG_ON
(
	`©omic_»ad
(&
wb
->
mig¿‹_io_couÁ
));

330 
k
 = 0; k < 
wb
->
num_emig¿‹s
; k++) {

331 
£g
 = *(
wb
->
emig¿‹s
 + 
k
);

332 
	`ş—nup_£gm’t
(
wb
, 
£g
);

343 
	`IO
(
	`blkdev_issue_æush
(
wb
->
Üigš_dev
->
bdev
, 
GFP_NOIO
, 
NULL
));

344 
	}
}

346 
	$do_mig¿‹_´oc
(
wb_deviû
 *
wb
)

348 
boŞ
 
®low_mig¿‹
;

349 
u32
 
i
, 
Ä_mig_ÿndid©es
, 
Ä_mig
, 
Ä_max_b©ch
;

350 
£gm’t_h—d”
 *
£g
;

352 
®low_mig¿‹
 = 
	`ACCESS_ONCE
(
wb
->
urge_mig¿‹
) ||

353 
	`ACCESS_ONCE
(
wb
->
®low_mig¿‹
);

355 ià(!
®low_mig¿‹
) {

356 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(1000));

360 
Ä_mig_ÿndid©es
 = 
	`©omic64_»ad
(&
wb
->
Ï¡_æushed_£gm’t_id
) -

361 
	`©omic64_»ad
(&
wb
->
Ï¡_mig¿‹d_£gm’t_id
);

363 ià(!
Ä_mig_ÿndid©es
) {

364 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(1000));

368 
Ä_max_b©ch
 = 
	`ACCESS_ONCE
(
wb
->
Ä_max_b©ched_mig¿tiÚ
);

369 ià(
wb
->
Ä_cur_b©ched_mig¿tiÚ
 !ğ
Ä_max_b©ch
)

370 
	`Œy_®loc_mig¿tiÚ_bufãr
(
wb
, 
Ä_max_b©ch
);

371 
Ä_mig
 = 
	`mš
(
Ä_mig_ÿndid©es
, 
wb
->
Ä_cur_b©ched_mig¿tiÚ
);

376 
i
 = 0; i < 
Ä_mig
; i++) {

377 
£g
 = 
	`g‘_£gm’t_h—d”_by_id
(
wb
,

378 
	`©omic64_»ad
(&
wb
->
Ï¡_mig¿‹d_£gm’t_id
è+ 1 + 
i
);

379 *(
wb
->
emig¿‹s
 + 
i
èğ
£g
;

381 
wb
->
num_emig¿‹s
 = 
Ä_mig
;

382 
	`Œª¥Üt_emig¿‹s
(
wb
);

384 
	`©omic64_add
(
Ä_mig
, &
wb
->
Ï¡_mig¿‹d_£gm’t_id
);

385 
	`wake_up_š‹¼u±ibË
(&
wb
->
mig¿‹_wa™_queue
);

386 
	}
}

388 
	$mig¿‹_´oc
(*
d©a
)

390 
wb_deviû
 *
wb
 = 
d©a
;

391 !
	`kth»ad_should_¡İ
())

392 
	`do_mig¿‹_´oc
(
wb
);

394 
	}
}

396 
	$wa™_fÜ_mig¿tiÚ
(
wb_deviû
 *
wb
, 
u64
 
id
)

402 
wb
->
urge_mig¿‹
 = 
Œue
;

403 
	`wake_up_´oûss
(
wb
->
mig¿‹_d«mÚ
);

404 
	`wa™_ev’t_š‹¼u±ibË
(
wb
->
mig¿‹_wa™_queue
,

405 
	`©omic64_»ad
(&
wb
->
Ï¡_mig¿‹d_£gm’t_id
è>ğ
id
);

406 
wb
->
urge_mig¿‹
 = 
çl£
;

407 
	}
}

411 
	$moduÏtÜ_´oc
(*
d©a
)

413 
wb_deviû
 *
wb
 = 
d©a
;

415 
hd_¡ruù
 *
hd
 = 
wb
->
Üigš_dev
->
bdev
->
bd_·¹
;

416 
Şd
 = 0, 
Ãw
, 
ut
;

417 
štvl
 = 1000;

419 !
	`kth»ad_should_¡İ
()) {

420 
Ãw
 = 
	`jiff›s_to_m£cs
(
	`·¹_¡©_»ad
(
hd
, 
io_ticks
));

422 ià(!
	`ACCESS_ONCE
(
wb
->
’abË_mig¿tiÚ_moduÏtÜ
))

423 
moduÏtÜ_upd©e
;

425 
ut
 = 
	`div_u64
(100 * (
Ãw
 - 
Şd
), 1000);

427 ià(
ut
 < 
	`ACCESS_ONCE
(
wb
->
mig¿‹_th»shŞd
))

428 
wb
->
®low_mig¿‹
 = 
Œue
;

430 
wb
->
®low_mig¿‹
 = 
çl£
;

432 
moduÏtÜ_upd©e
:

433 
Şd
 = 
Ãw
;

435 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(
štvl
));

438 
	}
}

442 
	$upd©e_su³rblock_»cÜd
(
wb_deviû
 *
wb
)

444 
r
 = 0;

446 
su³rblock_»cÜd_deviû
 
o
;

447 *
buf
;

448 
dm_io_»que¡
 
io_»q
;

449 
dm_io_»giÚ
 
»giÚ
;

451 
o
.
Ï¡_mig¿‹d_£gm’t_id
 =

452 
	`ıu_to_Ë64
(
	`©omic64_»ad
(&
wb
->
Ï¡_mig¿‹d_£gm’t_id
));

454 
buf
 = 
	`mempoŞ_®loc
(
wb
->
buf_1_poŞ
, 
GFP_NOIO
 | 
__GFP_ZERO
);

455 
	`memıy
(
buf
, &
o
, (o));

457 
io_»q
 = (
dm_io_»que¡
) {

458 .
ş›Á
 = 
wb_io_ş›Á
,

459 .
bi_rw
 = 
WRITE_FUA
,

460 .
nÙify
.
â
 = 
NULL
,

461 .
mem
.
ty³
 = 
DM_IO_KMEM
,

462 .
mem
.
±r
.
addr
 = 
buf
,

464 
»giÚ
 = (
dm_io_»giÚ
) {

465 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

466 .
£ùÜ
 = (1 << 11) - 1,

467 .
couÁ
 = 1,

469 
	`IO
(
	`dm_§ã_io
(&
io_»q
, 1, &
»giÚ
, 
NULL
, 
çl£
));

471 
	`mempoŞ_ä“
(
buf
, 
wb
->
buf_1_poŞ
);

472 
	}
}

474 
	$»cÜd”_´oc
(*
d©a
)

476 
wb_deviû
 *
wb
 = 
d©a
;

478 
štvl
;

480 !
	`kth»ad_should_¡İ
()) {

482 
štvl
 = 
	`ACCESS_ONCE
(
wb
->
upd©e_»cÜd_š‹rv®
) * 1000;

484 ià(!
štvl
) {

485 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(1000));

489 
	`upd©e_su³rblock_»cÜd
(
wb
);

490 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(
štvl
));

493 
	}
}

497 
	$sync_´oc
(*
d©a
)

499 
r
 = 0;

501 
wb_deviû
 *
wb
 = 
d©a
;

502 
štvl
;

504 !
	`kth»ad_should_¡İ
()) {

506 
štvl
 = 
	`ACCESS_ONCE
(
wb
->
sync_š‹rv®
) * 1000;

508 ià(!
štvl
) {

509 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(1000));

513 
	`æush_cu¼’t_bufãr
(
wb
);

514 
	`IO
(
	`blkdev_issue_æush
(
wb
->
ÿche_dev
->
bdev
, 
GFP_NOIO
, 
NULL
));

515 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(
štvl
));

518 
	}
}

	@dm-writeboost-daemon.h

7 #iâdeà
DM_WRITEBOOST_DAEMON_H


8 
	#DM_WRITEBOOST_DAEMON_H


	)

12 
æush_´oc
(
wÜk_¡ruù
 *);

13 
wa™_fÜ_æushšg
(
wb_deviû
 *, 
u64
 
id
);

17 
queue_b¬r›r_io
(
wb_deviû
 *, 
bio
 *);

18 
b¬r›r_d—dlše_´oc
(
d©a
);

19 
æush_b¬r›r_ios
(
wÜk_¡ruù
 *);

23 
mig¿‹_´oc
(*);

24 
wa™_fÜ_mig¿tiÚ
(
wb_deviû
 *, 
u64
 
id
);

28 
moduÏtÜ_´oc
(*);

32 
sync_´oc
(*);

36 
»cÜd”_´oc
(*);

	@dm-writeboost-metadata.c

7 
	~"dm-wr™eboo¡.h
"

8 
	~"dm-wr™eboo¡-m‘ad©a.h
"

9 
	~"dm-wr™eboo¡-d«mÚ.h
"

11 
	~<lšux/üc32c.h
>

15 
	s·¹
 {

16 *
	mmemÜy
;

19 
	sÏrge_¬¿y
 {

20 
·¹
 *
	m·¹s
;

21 
u64
 
	mÄ_–ems
;

22 
u32
 
	m–emsize
;

25 
	#ALLOC_SIZE
 (1 << 16)

	)

26 
u32
 
	$Ä_–ems_š_·¹
(
Ïrge_¬¿y
 *
¬r
)

28  
	`div_u64
(
ALLOC_SIZE
, 
¬r
->
–emsize
);

29 
	}
};

31 
u64
 
	$Ä_·¹s
(
Ïrge_¬¿y
 *
¬r
)

33 
u64
 
a
 = 
¬r
->
Ä_–ems
;

34 
u32
 
b
 = 
	`Ä_–ems_š_·¹
(
¬r
);

35  
	`div_u64
(
a
 + 
b
 - 1, b);

36 
	}
}

38 
Ïrge_¬¿y
 *
	$Ïrge_¬¿y_®loc
(
u32
 
–emsize
, 
u64
 
Ä_–ems
)

40 
u64
 
i
, 
j
;

41 
·¹
 *part;

43 
Ïrge_¬¿y
 *
¬r
 = 
	`km®loc
((*¬r), 
GFP_KERNEL
);

44 ià(!
¬r
) {

45 
	`WBERR
("failedo‡llocate‡rr");

46  
NULL
;

49 
¬r
->
–emsize
 =ƒlemsize;

50 
¬r
->
Ä_–ems
 =‚r_elems;

51 
¬r
->
·¹s
 = 
	`km®loc
((
·¹
è* 
	`Ä_·¹s
×¼), 
GFP_KERNEL
);

52 ià(!
¬r
->
·¹s
) {

53 
	`WBERR
("failedo‡llocate…arts");

54 
bad_®loc_·¹s
;

57 
i
 = 0; i < 
	`Ä_·¹s
(
¬r
); i++) {

58 
·¹
 = 
¬r
->
·¹s
 + 
i
;

59 
·¹
->
memÜy
 = 
	`km®loc
(
ALLOC_SIZE
, 
GFP_KERNEL
);

60 ià(!
·¹
->
memÜy
) {

61 
	`WBERR
("failedo‡llocate…art memory");

62 
j
 = 0; j < 
i
; j++) {

63 
·¹
 = 
¬r
->
·¹s
 + 
j
;

64 
	`kä“
(
·¹
->
memÜy
);

66 
bad_®loc_·¹s_memÜy
;

69  
¬r
;

71 
bad_®loc_·¹s_memÜy
:

72 
	`kä“
(
¬r
->
·¹s
);

73 
bad_®loc_·¹s
:

74 
	`kä“
(
¬r
);

75  
NULL
;

76 
	}
}

78 
	$Ïrge_¬¿y_ä“
(
Ïrge_¬¿y
 *
¬r
)

80 
size_t
 
i
;

81 
i
 = 0; i < 
	`Ä_·¹s
(
¬r
); i++) {

82 
·¹
 *·¹ = 
¬r
->
·¹s
 + 
i
;

83 
	`kä“
(
·¹
->
memÜy
);

85 
	`kä“
(
¬r
->
·¹s
);

86 
	`kä“
(
¬r
);

87 
	}
}

89 *
	$Ïrge_¬¿y_©
(
Ïrge_¬¿y
 *
¬r
, 
u64
 
i
)

91 
u32
 
n
 = 
	`Ä_–ems_š_·¹
(
¬r
);

92 
u32
 
k
;

93 
u64
 
j
 = 
	`div_u64_»m
(
i
, 
n
, &
k
);

94 
·¹
 *·¹ = 
¬r
->
·¹s
 + 
j
;

95  
·¹
->
memÜy
 + (
¬r
->
–emsize
 * 
k
);

96 
	}
}

103 
m‘ablock
 *
	$mb_©
(
wb_deviû
 *
wb
, 
u32
 
idx
)

105 
u32
 
idx_š£g
;

106 
u32
 
£g_idx
 = 
	`div_u64_»m
(
idx
, 
wb
->
Ä_ÿches_š£g
, &
idx_š£g
);

107 
£gm’t_h—d”
 *
£g
 =

108 
	`Ïrge_¬¿y_©
(
wb
->
£gm’t_h—d”_¬¿y
, 
£g_idx
);

109  
£g
->
mb_¬¿y
 + 
idx_š£g
;

110 
	}
}

112 
	$mb_¬¿y_em±y_š™
(
wb_deviû
 *
wb
)

114 
u32
 
i
;

115 
i
 = 0; i < 
wb
->
Ä_ÿches
; i++) {

116 
m‘ablock
 *
mb
 = 
	`mb_©
(
wb
, 
i
);

117 
	`INIT_HLIST_NODE
(&
mb
->
ht_li¡
);

119 
mb
->
idx
 = 
i
;

120 
mb
->
dœty_b™s
 = 0;

122 
	}
}

127 
£ùÜ_t
 
	$ÿlc_£gm’t_h—d”_¡¬t
(
wb_deviû
 *
wb
, 
u32
 
k
)

129  (1 << 11è+ (1 << 
wb
->
£gm’t_size_Üd”
è* 
k
;

130 
	}
}

132 
u32
 
	$ÿlc_Ä_£gm’ts
(
dm_dev
 *
dev
, 
wb_deviû
 *
wb
)

134 
£ùÜ_t
 
devsize
 = 
	`dm_devsize
(
dev
);

135  
	`div_u64
(
devsize
 - (1 << 11), 1 << 
wb
->
£gm’t_size_Üd”
);

136 
	}
}

141 
u32
 
	$mb_idx_š£g
(
wb_deviû
 *
wb
, 
u32
 
mb_idx
)

143 
u32
 
tmp32
;

144 
	`div_u64_»m
(
mb_idx
, 
wb
->
Ä_ÿches_š£g
, &
tmp32
);

145  
tmp32
;

146 
	}
}

151 
£ùÜ_t
 
	$ÿlc_mb_¡¬t_£ùÜ
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
, 
u32
 
mb_idx
)

153  
£g
->
¡¬t_£ùÜ
 + ((1 + 
	`mb_idx_š£g
(
wb
, 
mb_idx
)) << 3);

154 
	}
}

159 
£gm’t_h—d”
 *
	$mb_to_£g
(
wb_deviû
 *
wb
, 
m‘ablock
 *
mb
)

161 
£gm’t_h—d”
 *
£g
;

162 
£g
 = ((*è
mb
)

163 - 
	`mb_idx_š£g
(
wb
, 
mb
->
idx
è* (
m‘ablock
)

164 - (
£gm’t_h—d”
);

165  
£g
;

166 
	}
}

168 
boŞ
 
	$is_Ú_bufãr
(
wb_deviû
 *
wb
, 
u32
 
mb_idx
)

170 
u32
 
¡¬t
 = 
wb
->
cu¼’t_£g
->
¡¬t_idx
;

171 ià(
mb_idx
 < 
¡¬t
)

172  
çl£
;

174 ià(
mb_idx
 >ğ(
¡¬t
 + 
wb
->
Ä_ÿches_š£g
))

175  
çl£
;

177  
Œue
;

178 
	}
}

180 
u32
 
	$£gm’t_id_to_idx
(
wb_deviû
 *
wb
, 
u64
 
id
)

182 
u32
 
idx
;

183 
	`div_u64_»m
(
id
 - 1, 
wb
->
Ä_£gm’ts
, &
idx
);

184  
idx
;

185 
	}
}

187 
£gm’t_h—d”
 *
	$£gm’t_©
(
wb_deviû
 *
wb
, 
u32
 
k
)

189  
	`Ïrge_¬¿y_©
(
wb
->
£gm’t_h—d”_¬¿y
, 
k
);

190 
	}
}

196 
£gm’t_h—d”
 *

197 
	$g‘_£gm’t_h—d”_by_id
(
wb_deviû
 *
wb
, 
u64
 
id
)

199  
	`£gm’t_©
(
wb
, 
	`£gm’t_id_to_idx
(wb, 
id
));

200 
	}
}

204 
__mu¡_check
 
	$š™_£gm’t_h—d”_¬¿y
(
wb_deviû
 *
wb
)

206 
u32
 
£gm’t_idx
;

208 
wb
->
£gm’t_h—d”_¬¿y
 = 
	`Ïrge_¬¿y_®loc
(

209 (
£gm’t_h—d”
) +

210 (
m‘ablock
è* 
wb
->
Ä_ÿches_š£g
,

211 
wb
->
Ä_£gm’ts
);

212 ià(!
wb
->
£gm’t_h—d”_¬¿y
) {

213 
	`WBERR
("failedo‡llocate segment header‡rray");

214  -
ENOMEM
;

217 
£gm’t_idx
 = 0; segm’t_idx < 
wb
->
Ä_£gm’ts
; segment_idx++) {

218 
£gm’t_h—d”
 *
£g
 = 
	`Ïrge_¬¿y_©
(
wb
->
£gm’t_h—d”_¬¿y
, 
£gm’t_idx
);

220 
£g
->
id
 = 0;

221 
£g
->
Ëngth
 = 0;

222 
	`©omic_£t
(&
£g
->
Ä_šæight_ios
, 0);

227 
£g
->
¡¬t_idx
 = 
wb
->
Ä_ÿches_š£g
 * 
£gm’t_idx
;

228 
£g
->
¡¬t_£ùÜ
 = 
	`ÿlc_£gm’t_h—d”_¡¬t
(
wb
, 
£gm’t_idx
);

231 
	`mb_¬¿y_em±y_š™
(
wb
);

234 
	}
}

236 
	$ä“_£gm’t_h—d”_¬¿y
(
wb_deviû
 *
wb
)

238 
	`Ïrge_¬¿y_ä“
(
wb
->
£gm’t_h—d”_¬¿y
);

239 
	}
}

246 
__mu¡_check
 
	$ht_em±y_š™
(
wb_deviû
 *
wb
)

248 
u32
 
idx
;

249 
size_t
 
i
, 
Ä_h—ds
;

250 
Ïrge_¬¿y
 *
¬r
;

252 
wb
->
htsize
 = wb->
Ä_ÿches
;

253 
Ä_h—ds
 = 
wb
->
htsize
 + 1;

254 
¬r
 = 
	`Ïrge_¬¿y_®loc
((
ht_h—d
), 
Ä_h—ds
);

255 ià(!
¬r
) {

256 
	`WBERR
("failedo‡llocate‡rr");

257  -
ENOMEM
;

260 
wb
->
hbË
 = 
¬r
;

262 
i
 = 0; i < 
Ä_h—ds
; i++) {

263 
ht_h—d
 *
hd
 = 
	`Ïrge_¬¿y_©
(
¬r
, 
i
);

264 
	`INIT_HLIST_HEAD
(&
hd
->
ht_li¡
);

271 
wb
->
nuÎ_h—d
 = 
	`Ïrge_¬¿y_©
(wb->
hbË
, wb->
htsize
);

273 
idx
 = 0; idx < 
wb
->
Ä_ÿches
; idx++) {

274 
m‘ablock
 *
mb
 = 
	`mb_©
(
wb
, 
idx
);

275 
	`hli¡_add_h—d
(&
mb
->
ht_li¡
, &
wb
->
nuÎ_h—d
->ht_list);

279 
	}
}

281 
	$ä“_ht
(
wb_deviû
 *
wb
)

283 
	`Ïrge_¬¿y_ä“
(
wb
->
hbË
);

284 
	}
}

286 
ht_h—d
 *
	$ht_g‘_h—d
(
wb_deviû
 *
wb
, 
lookup_key
 *
key
)

288 
u32
 
idx
;

289 
	`div_u64_»m
(
key
->
£ùÜ
, 
wb
->
htsize
, &
idx
);

290  
	`Ïrge_¬¿y_©
(
wb
->
hbË
, 
idx
);

291 
	}
}

293 
boŞ
 
	$mb_h™
(
m‘ablock
 *
mb
, 
lookup_key
 *
key
)

295  
mb
->
£ùÜ
 =ğ
key
->sector;

296 
	}
}

302 
	$ht_d–
(
wb_deviû
 *
wb
, 
m‘ablock
 *
mb
)

304 
ht_h—d
 *
nuÎ_h—d
;

306 
	`hli¡_d–
(&
mb
->
ht_li¡
);

308 
nuÎ_h—d
 = 
wb
->null_head;

309 
	`hli¡_add_h—d
(&
mb
->
ht_li¡
, &
nuÎ_h—d
->ht_list);

310 
	}
}

312 
	$ht_»gi¡”
(
wb_deviû
 *
wb
, 
ht_h—d
 *
h—d
,

313 
lookup_key
 *
key
, 
m‘ablock
 *
mb
)

315 
	`hli¡_d–
(&
mb
->
ht_li¡
);

316 
	`hli¡_add_h—d
(&
mb
->
ht_li¡
, &
h—d
->ht_list);

318 
mb
->
£ùÜ
 = 
key
->sector;

319 
	}
};

321 
m‘ablock
 *
	$ht_lookup
(
wb_deviû
 *
wb
, 
ht_h—d
 *
h—d
,

322 
lookup_key
 *
key
)

324 
m‘ablock
 *
mb
, *
found
 = 
NULL
;

325 
	`hli¡_fÜ_—ch_’Œy
(
mb
, &
h—d
->
ht_li¡
, ht_list) {

326 ià(
	`mb_h™
(
mb
, 
key
)) {

327 
found
 = 
mb
;

331  
found
;

332 
	}
}

337 
	$disÿrd_ÿches_š£g
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
)

339 
u8
 
i
;

340 
i
 = 0; i < 
wb
->
Ä_ÿches_š£g
; i++) {

341 
m‘ablock
 *
mb
 = 
£g
->
mb_¬¿y
 + 
i
;

342 
	`ht_d–
(
wb
, 
mb
);

344 
	}
}

348 
	$»ad_su³rblock_h—d”
(
su³rblock_h—d”_deviû
 *
sup
,

349 
wb_deviû
 *
wb
)

351 
r
 = 0;

352 
dm_io_»que¡
 
io_»q_sup
;

353 
dm_io_»giÚ
 
»giÚ_sup
;

355 *
buf
 = 
	`km®loc
(1 << 
SECTOR_SHIFT
, 
GFP_KERNEL
);

356 ià(!
buf
)

357  -
ENOMEM
;

359 
io_»q_sup
 = (
dm_io_»que¡
) {

360 .
ş›Á
 = 
wb_io_ş›Á
,

361 .
bi_rw
 = 
READ
,

362 .
nÙify
.
â
 = 
NULL
,

363 .
mem
.
ty³
 = 
DM_IO_KMEM
,

364 .
mem
.
±r
.
addr
 = 
buf
,

366 
»giÚ_sup
 = (
dm_io_»giÚ
) {

367 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

368 .
£ùÜ
 = 0,

369 .
couÁ
 = 1,

371 
r
 = 
	`dm_§ã_io
(&
io_»q_sup
, 1, &
»giÚ_sup
, 
NULL
, 
çl£
);

372 ià(
r
) {

373 
	`WBERR
("I/O failed");

374 
bad_io
;

377 
	`memıy
(
sup
, 
buf
, (*sup));

379 
bad_io
:

380 
	`kä“
(
buf
);

382  
r
;

383 
	}
}

389 
__mu¡_check


390 
	$aud™_ÿche_deviû
(
wb_deviû
 *
wb
, 
boŞ
 *
Ãed_fÜm©
, boŞ *
®low_fÜm©
)

392 
r
 = 0;

393 
su³rblock_h—d”_deviû
 
sup
;

394 
r
 = 
	`»ad_su³rblock_h—d”
(&
sup
, 
wb
);

395 ià(
r
) {

396 
	`WBERR
("failedo„ead superblock header");

397  
r
;

400 *
Ãed_fÜm©
 = 
Œue
;

401 *
®low_fÜm©
 = 
çl£
;

403 ià(
	`Ë32_to_ıu
(
sup
.
magic
è!ğ
WB_MAGIC
) {

404 *
®low_fÜm©
 = 
Œue
;

405 
	`WBERR
("superblock header: magic‚umber invalid");

409 ià(
sup
.
£gm’t_size_Üd”
 !ğ
wb
->segment_size_order) {

410 
	`WBERR
("superblock header: segment order‚ot same %u != %u",

411 
sup
.
£gm’t_size_Üd”
, 
wb
->segment_size_order);

413 *
Ãed_fÜm©
 = 
çl£
;

416  
r
;

417 
	}
}

419 
	$fÜm©_su³rblock_h—d”
(
wb_deviû
 *
wb
)

421 
r
 = 0;

423 
dm_io_»que¡
 
io_»q_sup
;

424 
dm_io_»giÚ
 
»giÚ_sup
;

426 
su³rblock_h—d”_deviû
 
sup
 = {

427 .
magic
 = 
	`ıu_to_Ë32
(
WB_MAGIC
),

428 .
£gm’t_size_Üd”
 = 
wb
->segment_size_order,

431 *
buf
 = 
	`kz®loc
(1 << 
SECTOR_SHIFT
, 
GFP_KERNEL
);

432 ià(!
buf
)

433  -
ENOMEM
;

435 
	`memıy
(
buf
, &
sup
, (sup));

437 
io_»q_sup
 = (
dm_io_»que¡
) {

438 .
ş›Á
 = 
wb_io_ş›Á
,

439 .
bi_rw
 = 
WRITE_FUA
,

440 .
nÙify
.
â
 = 
NULL
,

441 .
mem
.
ty³
 = 
DM_IO_KMEM
,

442 .
mem
.
±r
.
addr
 = 
buf
,

444 
»giÚ_sup
 = (
dm_io_»giÚ
) {

445 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

446 .
£ùÜ
 = 0,

447 .
couÁ
 = 1,

449 
r
 = 
	`dm_§ã_io
(&
io_»q_sup
, 1, &
»giÚ_sup
, 
NULL
, 
çl£
);

450 ià(
r
) {

451 
	`WBERR
("I/O failed");

452 
bad_io
;

455 
bad_io
:

456 
	`kä“
(
buf
);

458 
	}
}

460 
	sfÜm©_£gmd_cÚ‹xt
 {

461 
	m”r
;

462 
©omic64_t
 
	mcouÁ
;

465 
	$fÜm©_£gmd_’dio
(
”rÜ
, *
__cÚ‹xt
)

467 
fÜm©_£gmd_cÚ‹xt
 *
cÚ‹xt
 = 
__cÚ‹xt
;

468 ià(
”rÜ
)

469 
cÚ‹xt
->
”r
 = 1;

470 
	`©omic64_dec
(&
cÚ‹xt
->
couÁ
);

471 
	}
}

473 
	$z”ošg_fuÎ_su³rblock
(
wb_deviû
 *
wb
)

475 
r
 = 0;

476 
dm_dev
 *
dev
 = 
wb
->
ÿche_dev
;

478 
dm_io_»que¡
 
io_»q_sup
;

479 
dm_io_»giÚ
 
»giÚ_sup
;

481 *
buf
 = 
	`kz®loc
(1 << 20, 
GFP_KERNEL
);

482 ià(!
buf
)

483  -
ENOMEM
;

485 
io_»q_sup
 = (
dm_io_»que¡
) {

486 .
ş›Á
 = 
wb_io_ş›Á
,

487 .
bi_rw
 = 
WRITE_FUA
,

488 .
nÙify
.
â
 = 
NULL
,

489 .
mem
.
ty³
 = 
DM_IO_KMEM
,

490 .
mem
.
±r
.
addr
 = 
buf
,

492 
»giÚ_sup
 = (
dm_io_»giÚ
) {

493 .
bdev
 = 
dev
->bdev,

494 .
£ùÜ
 = 0,

495 .
couÁ
 = (1 << 11),

497 
r
 = 
	`dm_§ã_io
(&
io_»q_sup
, 1, &
»giÚ_sup
, 
NULL
, 
çl£
);

498 ià(
r
) {

499 
	`WBERR
("I/O failed");

500 
bad_io
;

503 
bad_io
:

504 
	`kä“
(
buf
);

505  
r
;

506 
	}
}

508 
	$fÜm©_®l_£gm’t_h—d”s
(
wb_deviû
 *
wb
)

510 
r
 = 0;

511 
dm_dev
 *
dev
 = 
wb
->
ÿche_dev
;

512 
u32
 
i
, 
Ä_£gm’ts
 = 
	`ÿlc_Ä_£gm’ts
(
dev
, 
wb
);

514 
fÜm©_£gmd_cÚ‹xt
 
cÚ‹xt
;

516 *
buf
 = 
	`kz®loc
(1 << 12, 
GFP_KERNEL
);

517 ià(!
buf
)

518  -
ENOMEM
;

520 
	`©omic64_£t
(&
cÚ‹xt
.
couÁ
, 
Ä_£gm’ts
);

521 
cÚ‹xt
.
”r
 = 0;

526 
i
 = 0; i < 
Ä_£gm’ts
; i++) {

527 
dm_io_»que¡
 
io_»q_£g
 = {

528 .
ş›Á
 = 
wb_io_ş›Á
,

529 .
bi_rw
 = 
WRITE
,

530 .
nÙify
.
â
 = 
fÜm©_£gmd_’dio
,

531 .
nÙify
.
cÚ‹xt
 = &context,

532 .
mem
.
ty³
 = 
DM_IO_KMEM
,

533 .
mem
.
±r
.
addr
 = 
buf
,

535 
dm_io_»giÚ
 
»giÚ_£g
 = {

536 .
bdev
 = 
dev
->bdev,

537 .
£ùÜ
 = 
	`ÿlc_£gm’t_h—d”_¡¬t
(
wb
, 
i
),

538 .
couÁ
 = (1 << 3),

540 
r
 = 
	`dm_§ã_io
(&
io_»q_£g
, 1, &
»giÚ_£g
, 
NULL
, 
çl£
);

541 ià(
r
) {

542 
	`WBERR
("I/O failed");

546 
	`kä“
(
buf
);

548 ià(
r
)

549  
r
;

554 
	`©omic64_»ad
(&
cÚ‹xt
.
couÁ
))

555 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(100));

557 ià(
cÚ‹xt
.
”r
) {

558 
	`WBERR
("I/O failed‡t†ast");

559  -
EIO
;

562  
r
;

563 
	}
}

569 
__mu¡_check
 
	$fÜm©_ÿche_deviû
(
wb_deviû
 *
wb
)

571 
r
 = 0;

572 
dm_dev
 *
dev
 = 
wb
->
ÿche_dev
;

573 
r
 = 
	`z”ošg_fuÎ_su³rblock
(
wb
);

574 ià(
r
)

575  
r
;

576 
r
 = 
	`fÜm©_su³rblock_h—d”
(
wb
);

577 ià(
r
)

578  
r
;

579 
r
 = 
	`fÜm©_®l_£gm’t_h—d”s
(
wb
);

580 ià(
r
)

581  
r
;

582 
r
 = 
	`blkdev_issue_æush
(
dev
->
bdev
, 
GFP_KERNEL
, 
NULL
);

583  
r
;

584 
	}
}

590 
	$might_fÜm©_ÿche_deviû
(
wb_deviû
 *
wb
)

592 
r
 = 0;

594 
boŞ
 
Ãed_fÜm©
, 
®low_fÜm©
;

595 
r
 = 
	`aud™_ÿche_deviû
(
wb
, &
Ãed_fÜm©
, &
®low_fÜm©
);

596 ià(
r
) {

597 
	`WBERR
("failedo‡udit cache device");

598  
r
;

601 ià(
Ãed_fÜm©
) {

602 ià(
®low_fÜm©
) {

603 
r
 = 
	`fÜm©_ÿche_deviû
(
wb
);

604 ià(
r
) {

605 
	`WBERR
("failedo format cache device");

606  
r
;

609 
r
 = -
EINVAL
;

610 
	`WBERR
("cache device‚ot‡llowedo format");

611  
r
;

615  
r
;

616 
	}
}

620 
__mu¡_check


621 
	$»ad_su³rblock_»cÜd
(
su³rblock_»cÜd_deviû
 *
»cÜd
,

622 
wb_deviû
 *
wb
)

624 
r
 = 0;

625 
dm_io_»que¡
 
io_»q
;

626 
dm_io_»giÚ
 
»giÚ
;

628 *
buf
 = 
	`km®loc
(1 << 
SECTOR_SHIFT
, 
GFP_KERNEL
);

629 ià(!
buf
) {

630 
	`WBERR
();

631  -
ENOMEM
;

634 
io_»q
 = (
dm_io_»que¡
) {

635 .
ş›Á
 = 
wb_io_ş›Á
,

636 .
bi_rw
 = 
READ
,

637 .
nÙify
.
â
 = 
NULL
,

638 .
mem
.
ty³
 = 
DM_IO_KMEM
,

639 .
mem
.
±r
.
addr
 = 
buf
,

641 
»giÚ
 = (
dm_io_»giÚ
) {

642 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

643 .
£ùÜ
 = (1 << 11) - 1,

644 .
couÁ
 = 1,

646 
r
 = 
	`dm_§ã_io
(&
io_»q
, 1, &
»giÚ
, 
NULL
, 
çl£
);

647 ià(
r
) {

648 
	`WBERR
("I/O failed");

649 
bad_io
;

652 
	`memıy
(
»cÜd
, 
buf
, (*record));

654 
bad_io
:

655 
	`kä“
(
buf
);

657  
r
;

658 
	}
}

663 
__mu¡_check


664 
	$»ad_whŞe_£gm’t
(*
buf
, 
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
)

666 
dm_io_»que¡
 
io_»q
 = {

667 .
ş›Á
 = 
wb_io_ş›Á
,

668 .
bi_rw
 = 
READ
,

669 .
nÙify
.
â
 = 
NULL
,

670 .
mem
.
ty³
 = 
DM_IO_KMEM
,

671 .
mem
.
±r
.
addr
 = 
buf
,

673 
dm_io_»giÚ
 
»giÚ
 = {

674 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

675 .
£ùÜ
 = 
£g
->
¡¬t_£ùÜ
,

676 .
couÁ
 = 1 << 
wb
->
£gm’t_size_Üd”
,

678  
	`dm_§ã_io
(&
io_»q
, 1, &
»giÚ
, 
NULL
, 
çl£
);

679 
	}
}

685 
u32
 
	$ÿlc_checksum
(*
¿mbufãr
, 
u8
 
Ëngth
)

687 
Ën
 = (4096 - 512è+ 4096 * 
Ëngth
;

688  
	`üc32c
(
WB_CKSUM_SEED
, 
¿mbufãr
 + 512, 
Ën
);

689 
	}
}

694 
	$´•¬e_£gm’t_h—d”_deviû
(*
¿mbufãr
,

695 
wb_deviû
 *
wb
,

696 
£gm’t_h—d”
 *
¤c
)

698 
£gm’t_h—d”_deviû
 *
de¡
 = 
¿mbufãr
;

699 
u32
 
i
;

701 
	`BUG_ON
((
¤c
->
Ëngth
 - 1è!ğ
	`mb_idx_š£g
(
wb
, wb->
cursÜ
));

703 
i
 = 0; i < 
¤c
->
Ëngth
; i++) {

704 
m‘ablock
 *
mb
 = 
¤c
->
mb_¬¿y
 + 
i
;

705 
m‘ablock_deviû
 *
mbdev
 = 
de¡
->
mb¬r
 + 
i
;

707 
mbdev
->
£ùÜ
 = 
	`ıu_to_Ë64
(
mb
->sector);

708 
mbdev
->
dœty_b™s
 = 
mb
->dirty_bits;

711 
de¡
->
id
 = 
	`ıu_to_Ë64
(
¤c
->id);

712 
de¡
->
checksum
 = 
	`ıu_to_Ë32
(
	`ÿlc_checksum
(
¿mbufãr
, 
¤c
->
Ëngth
));

713 
de¡
->
Ëngth
 = 
¤c
->length;

714 
	}
}

717 
	$­¶y_m‘ablock_deviû
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
,

718 
£gm’t_h—d”_deviû
 *
¤c
, 
u8
 
i
)

720 
lookup_key
 
key
;

721 
ht_h—d
 *
h—d
;

722 
m‘ablock
 *
found
 = 
NULL
, *
mb
 = 
£g
->
mb_¬¿y
 + 
i
;

723 
m‘ablock_deviû
 *
mbdev
 = 
¤c
->
mb¬r
 + 
i
;

725 
mb
->
£ùÜ
 = 
	`Ë64_to_ıu
(
mbdev
->sector);

726 
mb
->
dœty_b™s
 = 
mbdev
->dirty_bits;

733 ià(!
mb
->
dœty_b™s
)

736 
key
 = (
lookup_key
) {

737 .
£ùÜ
 = 
mb
->sector,

739 
h—d
 = 
	`ht_g‘_h—d
(
wb
, &
key
);

740 
found
 = 
	`ht_lookup
(
wb
, 
h—d
, &
key
);

741 ià(
found
) {

742 
boŞ
 
ov”wr™e_fuÎsize
 = (
mb
->
dœty_b™s
 == 255);

743 
	`šv®id©e_´evious_ÿche
(
wb
, 
	`mb_to_£g
(wb, 
found
), found,

744 
ov”wr™e_fuÎsize
);

747 
	`šc_Ä_dœty_ÿches
(
wb
);

748 
	`ht_»gi¡”
(
wb
, 
h—d
, &
key
, 
mb
);

749 
	}
}

756 
	$­¶y_£gm’t_h—d”_deviû
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
,

757 
£gm’t_h—d”_deviû
 *
¤c
)

759 
u8
 
i
;

761 
£g
->
Ëngth
 = 
¤c
->length;

763 
i
 = 0; i < 
¤c
->
Ëngth
; i++)

764 
	`­¶y_m‘ablock_deviû
(
wb
, 
£g
, 
¤c
, 
i
);

765 
	}
}

773 
	$wr™eback_nÚ_vŞ©e_bufãrs
(
wb_deviû
 *
wb
)

776 
	}
}

778 
	$fšd_max_id
(
wb_deviû
 *
wb
, 
u64
 *
max_id
)

780 
r
 = 0;

782 *
¿mbuf
 = 
	`km®loc
(1 << (
wb
->
£gm’t_size_Üd”
 + 
SECTOR_SHIFT
),

783 
GFP_KERNEL
);

784 
u32
 
k
;

786 *
max_id
 = 0;

787 
k
 = 0; k < 
wb
->
Ä_£gm’ts
; k++) {

788 
£gm’t_h—d”
 *
£g
 = 
	`£gm’t_©
(
wb
, 
k
);

789 
£gm’t_h—d”_deviû
 *
h—d”
;

790 
r
 = 
	`»ad_whŞe_£gm’t
(
¿mbuf
, 
wb
, 
£g
);

791 ià(
r
) {

792 
	`kä“
(
¿mbuf
);

793  
r
;

796 
h—d”
 = 
¿mbuf
;

797 ià(
	`Ë64_to_ıu
(
h—d”
->
id
è> *
max_id
)

798 *
max_id
 = 
	`Ë64_to_ıu
(
h—d”
->
id
);

801 
	`kä“
(
¿mbuf
);

802  
r
;

803 
	}
}

805 
	$­¶y_v®id_£gm’ts
(
wb_deviû
 *
wb
, 
u64
 *
max_id
)

807 
r
 = 0;

808 
£gm’t_h—d”
 *
£g
;

809 
£gm’t_h—d”_deviû
 *
h—d”
;

811 *
¿mbuf
 = 
	`km®loc
(1 << (
wb
->
£gm’t_size_Üd”
 + 
SECTOR_SHIFT
),

812 
GFP_KERNEL
);

814 
u32
 
i
, 
¡¬t_idx
 = 
	`£gm’t_id_to_idx
(
wb
, *
max_id
 + 1);

815 *
max_id
 = 0;

816 
i
 = 
¡¬t_idx
; i < (¡¬t_idx + 
wb
->
Ä_£gm’ts
); i++) {

817 
u32
 
checksum1
, 
checksum2
, 
k
;

818 
	`div_u64_»m
(
i
, 
wb
->
Ä_£gm’ts
, &
k
);

819 
£g
 = 
	`£gm’t_©
(
wb
, 
k
);

821 
r
 = 
	`»ad_whŞe_£gm’t
(
¿mbuf
, 
wb
, 
£g
);

822 ià(
r
) {

823 
	`kä“
(
¿mbuf
);

824  
r
;

827 
h—d”
 = 
¿mbuf
;

829 ià(!
	`Ë64_to_ıu
(
h—d”
->
id
))

832 
checksum1
 = 
	`Ë32_to_ıu
(
h—d”
->
checksum
);

833 
checksum2
 = 
	`ÿlc_checksum
(
¿mbuf
, 
h—d”
->
Ëngth
);

834 ià(
checksum1
 !ğ
checksum2
) {

835 
	`DMWARN
("checksum inconsistent id:%llu checksum:%u != %u",

836 (è
	`Ë64_to_ıu
(
h—d”
->
id
),

837 
checksum1
, 
checksum2
);

841 
	`­¶y_£gm’t_h—d”_deviû
(
wb
, 
£g
, 
h—d”
);

842 *
max_id
 = 
	`Ë64_to_ıu
(
h—d”
->
id
);

844 
	`kä“
(
¿mbuf
);

845  
r
;

846 
	}
}

848 
	$šãr_Ï¡_mig¿‹d_id
(
wb_deviû
 *
wb
)

850 
r
 = 0;

852 
u64
 
»cÜd_id
;

853 
su³rblock_»cÜd_deviû
 
	`unš™Ÿlized_v¬
(
»cÜd
);

854 
r
 = 
	`»ad_su³rblock_»cÜd
(&
»cÜd
, 
wb
);

855 ià(
r
)

856  
r
;

857 
»cÜd_id
 = 
	`Ë64_to_ıu
(
»cÜd
.
Ï¡_mig¿‹d_£gm’t_id
);

859 
	`©omic64_£t
(&
wb
->
Ï¡_mig¿‹d_£gm’t_id
,

860 
	`©omic64_»ad
(&
wb
->
Ï¡_æushed_£gm’t_id
è> wb->
Ä_£gm’ts
 ?

861 
	`©omic64_»ad
(&
wb
->
Ï¡_æushed_£gm’t_id
è- wb->
Ä_£gm’ts
 : 0);

863 ià(
»cÜd_id
 > 
	`©omic64_»ad
(&
wb
->
Ï¡_mig¿‹d_£gm’t_id
))

864 
	`©omic64_£t
(&
wb
->
Ï¡_mig¿‹d_£gm’t_id
, 
»cÜd_id
);

866  
r
;

867 
	}
}

886 
	$»¶ay_log_Ú_ÿche
(
wb_deviû
 *
wb
)

888 
r
 = 0;

889 
u64
 
max_id
;

891 
r
 = 
	`fšd_max_id
(
wb
, &
max_id
);

892 ià(
r
) {

893 
	`WBERR
("failedo find max id");

894  
r
;

896 
r
 = 
	`­¶y_v®id_£gm’ts
(
wb
, &
max_id
);

897 ià(
r
) {

898 
	`WBERR
("failedo‡pply valid segments");

899  
r
;

905 
	`©omic64_£t
(&
wb
->
Ï¡_æushed_£gm’t_id
, 
max_id
);

910 
	`šãr_Ï¡_mig¿‹d_id
(
wb
);

912  
r
;

913 
	}
}

918 
	$´•¬e_fœ¡_£g
(
wb_deviû
 *
wb
)

920 
u64
 
š™_£gm’t_id
 = 
	`©omic64_»ad
(&
wb
->
Ï¡_æushed_£gm’t_id
) + 1;

921 
	`acquœe_Ãw_£g
(
wb
, 
š™_£gm’t_id
);

927 
wb
->
cursÜ
 = wb->
cu¼’t_£g
->
¡¬t_idx
;

928 
wb
->
cu¼’t_£g
->
Ëngth
 = 1;

929 
	}
}

935 
__mu¡_check
 
	$»cov”_ÿche
(
wb_deviû
 *
wb
)

937 
r
 = 0;

939 
r
 = 
	`wr™eback_nÚ_vŞ©e_bufãrs
(
wb
);

940 ià(
r
) {

941 
	`WBERR
("failedo write back‡llhe…ersistent data on‚on-volatile RAM");

942  
r
;

945 
r
 = 
	`»¶ay_log_Ú_ÿche
(
wb
);

946 ià(
r
) {

947 
	`WBERR
("failedo„eplay†og");

948  
r
;

951 
	`´•¬e_fœ¡_£g
(
wb
);

953 
	}
}

957 
__mu¡_check
 
	$š™_¿mbuf_poŞ
(
wb_deviû
 *
wb
)

959 
size_t
 
i
;

960 
size_t
 
®loc_sz
 = 1 << (
wb
->
£gm’t_size_Üd”
 + 
SECTOR_SHIFT
);

961 
u32
 
Ä
 = 
	`div_u64
(
wb
->
¿mbuf_poŞ_amouÁ
 * 1000, 
®loc_sz
);

963 ià(!
Ä
)

964  -
EINVAL
;

966 
wb
->
Ä_¿mbuf_poŞ
 = 
Ä
;

967 
wb
->
¿mbuf_poŞ
 = 
	`km®loc
((
¿mbufãr
è* 
Ä
,

968 
GFP_KERNEL
);

969 ià(!
wb
->
¿mbuf_poŞ
)

970  -
ENOMEM
;

972 
i
 = 0; i < 
wb
->
Ä_¿mbuf_poŞ
; i++) {

973 
size_t
 
j
;

974 
¿mbufãr
 *
¿mbuf
 = 
wb
->
¿mbuf_poŞ
 + 
i
;

976 
¿mbuf
->
d©a
 = 
	`km®loc
(
®loc_sz
, 
GFP_KERNEL
);

977 ià(!
¿mbuf
->
d©a
) {

978 
	`WBERR
("failedo‡llocate„ambuf data");

979 
j
 = 0; j < 
i
; j++) {

980 
¿mbuf
 = 
wb
->
¿mbuf_poŞ
 + 
j
;

981 
	`kä“
(
¿mbuf
->
d©a
);

983 
	`kä“
(
wb
->
¿mbuf_poŞ
);

984  -
ENOMEM
;

989 
	}
}

991 
	$ä“_¿mbuf_poŞ
(
wb_deviû
 *
wb
)

993 
size_t
 
i
;

994 
i
 = 0; i < 
wb
->
Ä_¿mbuf_poŞ
; i++) {

995 
¿mbufãr
 *
¿mbuf
 = 
wb
->
¿mbuf_poŞ
 + 
i
;

996 
	`kä“
(
¿mbuf
->
d©a
);

998 
	`kä“
(
wb
->
¿mbuf_poŞ
);

999 
	}
}

1010 
	$Œy_®loc_mig¿tiÚ_bufãr
(
wb_deviû
 *
wb
, 
size_t
 
Ä_b©ch
)

1012 
r
 = 0;

1014 
£gm’t_h—d”
 **
emig¿‹s
;

1015 *
buf
;

1016 *
¢­shÙ
;

1018 
emig¿‹s
 = 
	`km®loc
(
Ä_b©ch
 * (
£gm’t_h—d”
 *), 
GFP_KERNEL
);

1019 ià(!
emig¿‹s
) {

1020 
	`WBERR
("failedo‡llocateƒmigrates");

1021 
r
 = -
ENOMEM
;

1022  
r
;

1025 
buf
 = 
	`vm®loc
(
Ä_b©ch
 * (
wb
->
Ä_ÿches_š£g
 << 12));

1026 ià(!
buf
) {

1027 
	`WBERR
("failedo‡llocate migration buffer");

1028 
r
 = -
ENOMEM
;

1029 
bad_®loc_bufãr
;

1032 
¢­shÙ
 = 
	`km®loc
(
Ä_b©ch
 * 
wb
->
Ä_ÿches_š£g
, 
GFP_KERNEL
);

1033 ià(!
¢­shÙ
) {

1034 
	`WBERR
("failedo‡llocate dirty snapshot");

1035 
r
 = -
ENOMEM
;

1036 
bad_®loc_¢­shÙ
;

1042 
	`kä“
(
wb
->
emig¿‹s
);

1043 ià(
wb
->
mig¿‹_bufãr
)

1044 
	`vä“
(
wb
->
mig¿‹_bufãr
);

1045 
	`kä“
(
wb
->
dœtšess_¢­shÙ
);

1050 
wb
->
emig¿‹s
 =ƒmigrates;

1051 
wb
->
mig¿‹_bufãr
 = 
buf
;

1052 
wb
->
dœtšess_¢­shÙ
 = 
¢­shÙ
;

1053 
wb
->
Ä_cur_b©ched_mig¿tiÚ
 = 
Ä_b©ch
;

1055  
r
;

1057 
bad_®loc_bufãr
:

1058 
	`kä“
(
wb
->
emig¿‹s
);

1059 
bad_®loc_¢­shÙ
:

1060 
	`vä“
(
wb
->
mig¿‹_bufãr
);

1062  
r
;

1063 
	}
}

1065 
	$ä“_mig¿tiÚ_bufãr
(
wb_deviû
 *
wb
)

1067 
	`kä“
(
wb
->
emig¿‹s
);

1068 
	`vä“
(
wb
->
mig¿‹_bufãr
);

1069 
	`kä“
(
wb
->
dœtšess_¢­shÙ
);

1070 
	}
}

1074 
	#CREATE_DAEMON
(
Çme
) \

1076 
wb
->
Çme
##
_d«mÚ
 = 
	`kth»ad_ü—‹
( \

1077 
Çme
##
_´oc
, 
wb
, #name "_daemon"); \

1078 ià(
	`IS_ERR
(
wb
->
Çme
##
_d«mÚ
)) { \

1079 
r
 = 
	`PTR_ERR
(
wb
->
Çme
##
_d«mÚ
); \

1080 
wb
->
Çme
##
_d«mÚ
 = 
NULL
; \

1081 
	`WBERR
("couldn't spawn" #name "daemon"); \

1082 
bad_
##
Çme
##
_d«mÚ
; \

1084 
	`wake_up_´oûss
(
wb
->
Çme
##
_d«mÚ
); \

1085 } 0)

	)

1087 
	$h¬mËss_š™
(
wb_deviû
 *
wb
)

1089 
r
 = 0;

1091 
	`mu‹x_š™
(&
wb
->
io_lock
);

1093 
wb
->
Ä_£gm’ts
 = 
	`ÿlc_Ä_£gm’ts
(wb->
ÿche_dev
, wb);

1094 
wb
->
Ä_ÿches_š£g
 = (1 << (wb->
£gm’t_size_Üd”
 - 3)) - 1;

1095 
wb
->
Ä_ÿches
 = wb->
Ä_£gm’ts
 * wb->
Ä_ÿches_š£g
;

1097 
wb
->
buf_1_poŞ
 = 
	`mempoŞ_ü—‹_km®loc_poŞ
(16, 1 << 
SECTOR_SHIFT
);

1098 ià(!
wb
->
buf_1_poŞ
) {

1099 
r
 = -
ENOMEM
;

1100 
	`WBERR
("failedo‡llocate 1 sector…ool");

1101 
bad_buf_1_poŞ
;

1103 
wb
->
buf_8_poŞ
 = 
	`mempoŞ_ü—‹_km®loc_poŞ
(16, 8 << 
SECTOR_SHIFT
);

1104 ià(!
wb
->
buf_8_poŞ
) {

1105 
r
 = -
ENOMEM
;

1106 
	`WBERR
("failedo‡llocate 8 sector…ool");

1107 
bad_buf_8_poŞ
;

1110 
r
 = 
	`š™_¿mbuf_poŞ
(
wb
);

1111 ià(
r
) {

1112 
	`WBERR
("failedo‡llocate„ambuf…ool");

1113 
bad_š™_¿mbuf_poŞ
;

1115 
wb
->
æush_job_poŞ
 = 
	`mempoŞ_ü—‹_km®loc_poŞ
(

1116 
wb
->
Ä_¿mbuf_poŞ
, (
æush_job
));

1117 ià(!
wb
->
æush_job_poŞ
) {

1118 
r
 = -
ENOMEM
;

1119 
	`WBERR
("failedo‡llocate flush job…ool");

1120 
bad_æush_job_poŞ
;

1123 
r
 = 
	`š™_£gm’t_h—d”_¬¿y
(
wb
);

1124 ià(
r
) {

1125 
	`WBERR
("failedo‡llocate segment header‡rray");

1126 
bad_®loc_£gm’t_h—d”_¬¿y
;

1129 
r
 = 
	`ht_em±y_š™
(
wb
);

1130 ià(
r
) {

1131 
	`WBERR
("failedo‡llocate hashtable");

1132 
bad_®loc_ht
;

1135  
r
;

1137 
bad_®loc_ht
:

1138 
	`ä“_£gm’t_h—d”_¬¿y
(
wb
);

1139 
bad_®loc_£gm’t_h—d”_¬¿y
:

1140 
	`mempoŞ_de¡roy
(
wb
->
æush_job_poŞ
);

1141 
bad_æush_job_poŞ
:

1142 
	`ä“_¿mbuf_poŞ
(
wb
);

1143 
bad_š™_¿mbuf_poŞ
:

1144 
	`mempoŞ_de¡roy
(
wb
->
buf_8_poŞ
);

1145 
bad_buf_8_poŞ
:

1146 
	`mempoŞ_de¡roy
(
wb
->
buf_1_poŞ
);

1147 
bad_buf_1_poŞ
:

1149  
r
;

1150 
	}
}

1152 
	$h¬mËss_ä“
(
wb_deviû
 *
wb
)

1154 
	`ä“_ht
(
wb
);

1155 
	`ä“_£gm’t_h—d”_¬¿y
(
wb
);

1156 
	`mempoŞ_de¡roy
(
wb
->
æush_job_poŞ
);

1157 
	`ä“_¿mbuf_poŞ
(
wb
);

1158 
	`mempoŞ_de¡roy
(
wb
->
buf_8_poŞ
);

1159 
	`mempoŞ_de¡roy
(
wb
->
buf_1_poŞ
);

1160 
	}
}

1162 
	$š™_mig¿‹_d«mÚ
(
wb_deviû
 *
wb
)

1164 
r
 = 0;

1165 
size_t
 
Ä_b©ch
;

1167 
	`©omic_£t
(&
wb
->
mig¿‹_ç_couÁ
, 0);

1168 
	`©omic_£t
(&
wb
->
mig¿‹_io_couÁ
, 0);

1174 
Ä_b©ch
 = 1 << (11 - 
wb
->
£gm’t_size_Üd”
);

1175 
wb
->
Ä_max_b©ched_mig¿tiÚ
 = 
Ä_b©ch
;

1176 ià(
	`Œy_®loc_mig¿tiÚ_bufãr
(
wb
, 
Ä_b©ch
))

1177  -
ENOMEM
;

1179 
	`š™_wa™queue_h—d
(&
wb
->
mig¿‹_wa™_queue
);

1180 
	`š™_wa™queue_h—d
(&
wb
->
wa™_drİ_ÿches
);

1181 
	`š™_wa™queue_h—d
(&
wb
->
mig¿‹_io_wa™_queue
);

1183 
wb
->
®low_mig¿‹
 = 
çl£
;

1184 
wb
->
urge_mig¿‹
 = 
çl£
;

1185 
	`CREATE_DAEMON
(
mig¿‹
);

1187  
r
;

1189 
bad_mig¿‹_d«mÚ
:

1190 
	`ä“_mig¿tiÚ_bufãr
(
wb
);

1191  
r
;

1192 
	}
}

1194 
	$š™_æush”
(
wb_deviû
 *
wb
)

1196 
r
 = 0;

1197 
wb
->
æush”_wq
 = 
	`®loc_wÜkqueue
(

1198 "%s", 
WQ_MEM_RECLAIM
 | 
WQ_SYSFS
, 1, "wbflusher");

1199 ià(!
wb
->
æush”_wq
) {

1200 
	`WBERR
("failedo‡llocate wbflusher");

1201  -
ENOMEM
;

1203 
	`š™_wa™queue_h—d
(&
wb
->
æush_wa™_queue
);

1204  
r
;

1205 
	}
}

1207 
	$š™_b¬r›r_d—dlše_wÜk
(
wb_deviû
 *
wb
)

1209 
wb
->
b¬r›r_d—dlše_ms
 = 3;

1210 
	`£tup_tim”
(&
wb
->
b¬r›r_d—dlše_tim”
,

1211 
b¬r›r_d—dlše_´oc
, (è
wb
);

1212 
	`bio_li¡_š™
(&
wb
->
b¬r›r_ios
);

1213 
	`INIT_WORK
(&
wb
->
b¬r›r_d—dlše_wÜk
, 
æush_b¬r›r_ios
);

1214 
	}
}

1216 
	$š™_mig¿‹_moduÏtÜ
(
wb_deviû
 *
wb
)

1218 
r
 = 0;

1223 
wb
->
mig¿‹_th»shŞd
 = 70;

1224 
wb
->
’abË_mig¿tiÚ_moduÏtÜ
 = 
Œue
;

1225 
	`CREATE_DAEMON
(
moduÏtÜ
);

1226  
r
;

1228 
bad_moduÏtÜ_d«mÚ
:

1229  
r
;

1230 
	}
}

1232 
	$š™_»cÜd”_d«mÚ
(
wb_deviû
 *
wb
)

1234 
r
 = 0;

1235 
wb
->
upd©e_»cÜd_š‹rv®
 = 60;

1236 
	`CREATE_DAEMON
(
»cÜd”
);

1237  
r
;

1239 
bad_»cÜd”_d«mÚ
:

1240  
r
;

1241 
	}
}

1243 
	$š™_sync_d«mÚ
(
wb_deviû
 *
wb
)

1245 
r
 = 0;

1246 
wb
->
sync_š‹rv®
 = 60;

1247 
	`CREATE_DAEMON
(
sync
);

1248  
r
;

1250 
bad_sync_d«mÚ
:

1251  
r
;

1252 
	}
}

1254 
__mu¡_check
 
	$»sume_ÿche
(
wb_deviû
 *
wb
)

1256 
r
 = 0;

1258 
r
 = 
	`might_fÜm©_ÿche_deviû
(
wb
);

1259 ià(
r
)

1260 
bad_might_fÜm©_ÿche
;

1261 
r
 = 
	`h¬mËss_š™
(
wb
);

1262 ià(
r
)

1263 
bad_h¬mËss_š™
;

1264 
r
 = 
	`š™_mig¿‹_d«mÚ
(
wb
);

1265 ià(
r
) {

1266 
	`WBERR
("failedo init migrate daemon");

1267 
bad_mig¿‹_d«mÚ
;

1269 
r
 = 
	`»cov”_ÿche
(
wb
);

1270 ià(
r
) {

1271 
	`WBERR
("failedo„ecover cache metadata");

1272 
bad_»cov”
;

1274 
r
 = 
	`š™_æush”
(
wb
);

1275 ià(
r
) {

1276 
	`WBERR
("failedo init wbflusher");

1277 
bad_æush”
;

1279 
	`š™_b¬r›r_d—dlše_wÜk
(
wb
);

1280 
r
 = 
	`š™_mig¿‹_moduÏtÜ
(
wb
);

1281 ià(
r
) {

1282 
	`WBERR
("failedo init migrate modulator");

1283 
bad_mig¿‹_moduÏtÜ
;

1285 
r
 = 
	`š™_»cÜd”_d«mÚ
(
wb
);

1286 ià(
r
) {

1287 
	`WBERR
("failedo init superblock„ecorder");

1288 
bad_»cÜd”_d«mÚ
;

1290 
r
 = 
	`š™_sync_d«mÚ
(
wb
);

1291 ià(
r
) {

1292 
	`WBERR
("failedo init sync daemon");

1293 
bad_sync_d«mÚ
;

1296  
r
;

1298 
bad_sync_d«mÚ
:

1299 
	`kth»ad_¡İ
(
wb
->
»cÜd”_d«mÚ
);

1300 
bad_»cÜd”_d«mÚ
:

1301 
	`kth»ad_¡İ
(
wb
->
moduÏtÜ_d«mÚ
);

1302 
bad_mig¿‹_moduÏtÜ
:

1303 
	`ÿnûl_wÜk_sync
(&
wb
->
b¬r›r_d—dlše_wÜk
);

1304 
	`de¡roy_wÜkqueue
(
wb
->
æush”_wq
);

1305 
bad_æush”
:

1306 
bad_»cov”
:

1307 
	`kth»ad_¡İ
(
wb
->
mig¿‹_d«mÚ
);

1308 
	`ä“_mig¿tiÚ_bufãr
(
wb
);

1309 
bad_mig¿‹_d«mÚ
:

1310 
	`h¬mËss_ä“
(
wb
);

1311 
bad_h¬mËss_š™
:

1312 
bad_might_fÜm©_ÿche
:

1314  
r
;

1315 
	}
}

1317 
	$ä“_ÿche
(
wb_deviû
 *
wb
)

1323 
	`kth»ad_¡İ
(
wb
->
sync_d«mÚ
);

1324 
	`kth»ad_¡İ
(
wb
->
»cÜd”_d«mÚ
);

1325 
	`kth»ad_¡İ
(
wb
->
moduÏtÜ_d«mÚ
);

1327 
	`ÿnûl_wÜk_sync
(&
wb
->
b¬r›r_d—dlše_wÜk
);

1329 
	`de¡roy_wÜkqueue
(
wb
->
æush”_wq
);

1331 
	`kth»ad_¡İ
(
wb
->
mig¿‹_d«mÚ
);

1332 
	`ä“_mig¿tiÚ_bufãr
(
wb
);

1334 
	`h¬mËss_ä“
(
wb
);

1335 
	}
}

	@dm-writeboost-metadata.h

7 #iâdeà
DM_WRITEBOOST_METADATA_H


8 
	#DM_WRITEBOOST_METADATA_H


	)

12 
£gm’t_h—d”
 *

13 
g‘_£gm’t_h—d”_by_id
(
wb_deviû
 *, 
u64
 
£gm’t_id
);

14 
£ùÜ_t
 
ÿlc_mb_¡¬t_£ùÜ
(
wb_deviû
 *, 
£gm’t_h—d”
 *,

15 
u32
 
mb_idx
);

16 
u32
 
mb_idx_š£g
(
wb_deviû
 *, u32 
mb_idx
);

17 
£gm’t_h—d”
 *
mb_to_£g
(
wb_deviû
 *, 
m‘ablock
 *);

18 
boŞ
 
is_Ú_bufãr
(
wb_deviû
 *, 
u32
 
mb_idx
);

22 
	slookup_key
 {

23 
£ùÜ_t
 
	m£ùÜ
;

26 
	sht_h—d
 {

27 
hli¡_h—d
 
	mht_li¡
;

29 
ht_h—d
 *
ht_g‘_h—d
(
wb_deviû
 *, 
lookup_key
 *);

30 
m‘ablock
 *
ht_lookup
(
wb_deviû
 *,

31 
ht_h—d
 *, 
lookup_key
 *);

32 
ht_»gi¡”
(
wb_deviû
 *, 
ht_h—d
 *,

33 
lookup_key
 *, 
m‘ablock
 *);

34 
ht_d–
(
wb_deviû
 *, 
m‘ablock
 *);

35 
disÿrd_ÿches_š£g
(
wb_deviû
 *, 
£gm’t_h—d”
 *);

39 
´•¬e_£gm’t_h—d”_deviû
(*
¿mbufãr
, 
wb_deviû
 *,

40 
£gm’t_h—d”
 *
¤c
);

44 
Œy_®loc_mig¿tiÚ_bufãr
(
wb_deviû
 *, 
size_t
 
Ä_b©ch
);

48 
__mu¡_check
 
»sume_ÿche
(
wb_deviû
 *);

49 
ä“_ÿche
(
wb_deviû
 *);

	@dm-writeboost-target.c

10 
	~"dm-wr™eboo¡.h
"

11 
	~"dm-wr™eboo¡-m‘ad©a.h
"

12 
	~"dm-wr™eboo¡-d«mÚ.h
"

16 
	s§ã_io
 {

17 
wÜk_¡ruù
 
	mwÜk
;

18 
	m”r
;

19 
	m”r_b™s
;

20 
dm_io_»que¡
 *
	mio_»q
;

21 
	mnum_»giÚs
;

22 
dm_io_»giÚ
 *
	m»giÚs
;

25 
	$§ã_io_´oc
(
wÜk_¡ruù
 *
wÜk
)

27 
§ã_io
 *
io
 = 
	`cÚš”_of
(
wÜk
, safe_io, work);

28 
io
->
”r_b™s
 = 0;

29 
io
->
”r
 = 
	`dm_io
(io->
io_»q
, io->
num_»giÚs
, io->
»giÚs
,

30 &
io
->
”r_b™s
);

31 
	}
}

33 
	$dm_§ã_io_š‹º®
(
wb_deviû
 *
wb
, 
dm_io_»que¡
 *
io_»q
,

34 
num_»giÚs
, 
dm_io_»giÚ
 *
»giÚs
,

35 *
”r_b™s
, 
boŞ
 
th»ad
, cÚ¡ *
ÿÎ”
)

37 
”r
 = 0;

39 ià(
th»ad
) {

40 
§ã_io
 
io
 = {

41 .
io_»q
 = io_req,

42 .
»giÚs
 =„egions,

43 .
num_»giÚs
 =‚um_regions,

46 
	`INIT_WORK_ONSTACK
(&
io
.
wÜk
, 
§ã_io_´oc
);

48 
	`queue_wÜk
(
§ã_io_wq
, &
io
.
wÜk
);

49 
	`æush_wÜk
(&
io
.
wÜk
);

51 
”r
 = 
io
.err;

52 ià(
”r_b™s
)

53 *
”r_b™s
 = 
io
.err_bits;

55 
”r
 = 
	`dm_io
(
io_»q
, 
num_»giÚs
, 
»giÚs
, 
”r_b™s
);

61 ià(
”r
 || (
”r_b™s
 && *err_bits)) {

62 
buf
[
BDEVNAME_SIZE
];

63 
dev_t
 
dev
 = 
»giÚs
->
bdev
->
bd_dev
;

65 
eb
;

66 ià(!
”r_b™s
)

67 
eb
 = (~()0);

69 
eb
 = *
”r_b™s
;

71 
	`fÜm©_dev_t
(
buf
, 
dev
);

72 
	`WBERR
("%s() I/Oƒrror(%d), bits(%lu), dev(%s), sector(%llu),„w(%d)",

73 
ÿÎ”
, 
”r
, 
eb
,

74 
buf
, (è
»giÚs
->
£ùÜ
, 
io_»q
->
bi_rw
);

77  
”r
;

78 
	}
}

80 
£ùÜ_t
 
	$dm_devsize
(
dm_dev
 *
dev
)

82  
	`i_size_»ad
(
dev
->
bdev
->
bd_šode
è>> 
SECTOR_SHIFT
;

83 
	}
}

87 
u8
 
	$couÁ_dœty_ÿches_»mašed
(
£gm’t_h—d”
 *
£g
)

89 
u8
 
i
, 
couÁ
 = 0;

90 
m‘ablock
 *
mb
;

91 
i
 = 0; i < 
£g
->
Ëngth
; i++) {

92 
mb
 = 
£g
->
mb_¬¿y
 + 
i
;

93 ià(
mb
->
dœty_b™s
)

94 
couÁ
++;

96  
couÁ
;

97 
	}
}

106 
	$´•¬e_¿mbufãr
(
¿mbufãr
 *
¿mbuf
,

107 
wb_deviû
 *
wb
,

108 
£gm’t_h—d”
 *
£g
)

110 
	`´•¬e_£gm’t_h—d”_deviû
(
¿mbuf
->
d©a
, 
wb
, 
£g
);

111 
	}
}

113 
	$š™_¿mbufãr
(
wb_deviû
 *
wb
)

115 
	`mem£t
(
wb
->
cu¼’t_¿mbuf
->
d©a
, 0, 1 << 12);

116 
	}
}

123 
	$acquœe_Ãw_¿mbufãr
(
wb_deviû
 *
wb
, 
u64
 
id
)

125 
¿mbufãr
 *
Ãxt_¿mbuf
;

126 
u32
 
tmp32
;

128 
	`wa™_fÜ_æushšg
(
wb
, 
	`SUB_ID
(
id
, wb->
Ä_¿mbuf_poŞ
));

130 
	`div_u64_»m
(
id
 - 1, 
wb
->
Ä_¿mbuf_poŞ
, &
tmp32
);

131 
Ãxt_¿mbuf
 = 
wb
->
¿mbuf_poŞ
 + 
tmp32
;

133 
wb
->
cu¼’t_¿mbuf
 = 
Ãxt_¿mbuf
;

135 
	`š™_¿mbufãr
(
wb
);

136 
	}
}

143 
	$acquœe_Ãw_£g
(
wb_deviû
 *
wb
, 
u64
 
id
)

145 
£gm’t_h—d”
 *
Ãw_£g
 = 
	`g‘_£gm’t_h—d”_by_id
(
wb
, 
id
);

151 
size_t
 
»p
 = 0;

152 
	`©omic_»ad
(&
Ãw_£g
->
Ä_šæight_ios
)) {

153 
»p
++;

154 ià(
»p
 == 1000)

155 
	`WBWARN
("too†ongo…rocess‡ll„equests");

156 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(1));

158 
	`BUG_ON
(
	`couÁ_dœty_ÿches_»mašed
(
Ãw_£g
));

160 
	`wa™_fÜ_mig¿tiÚ
(
wb
, 
	`SUB_ID
(
id
, wb->
Ä_£gm’ts
));

162 
	`disÿrd_ÿches_š£g
(
wb
, 
Ãw_£g
);

168 
Ãw_£g
->
id
 = id;

169 
wb
->
cu¼’t_£g
 = 
Ãw_£g
;

171 
	`acquœe_Ãw_¿mbufãr
(
wb
, 
id
);

172 
	}
}

174 
	$´•¬e_Ãw_£g
(
wb_deviû
 *
wb
)

176 
u64
 
Ãxt_id
 = 
wb
->
cu¼’t_£g
->
id
 + 1;

177 
	`acquœe_Ãw_£g
(
wb
, 
Ãxt_id
);

182 
wb
->
cursÜ
 = wb->
cu¼’t_£g
->
¡¬t_idx
 + (wb->
Ä_ÿches_š£g
 - 1);

183 
wb
->
cu¼’t_£g
->
Ëngth
 = 0;

184 
	}
}

187 
	$cİy_b¬r›r_»que¡s
(
æush_job
 *
job
, 
wb_deviû
 *
wb
)

189 
	`bio_li¡_š™
(&
job
->
b¬r›r_ios
);

190 
	`bio_li¡_m”ge
(&
job
->
b¬r›r_ios
, &
wb
->barrier_ios);

191 
	`bio_li¡_š™
(&
wb
->
b¬r›r_ios
);

192 
	}
}

194 
	$š™_æush_job
(
æush_job
 *
job
, 
wb_deviû
 *
wb
)

196 
job
->
wb
 = wb;

197 
job
->
£g
 = 
wb
->
cu¼’t_£g
;

198 
job
->
¿mbuf
 = 
wb
->
cu¼’t_¿mbuf
;

200 
	`cİy_b¬r›r_»que¡s
(
job
, 
wb
);

201 
	}
}

203 
	$queue_æush_job
(
wb_deviû
 *
wb
)

205 
æush_job
 *
job
;

206 
size_t
 
»p
 = 0;

208 
	`©omic_»ad
(&
wb
->
cu¼’t_£g
->
Ä_šæight_ios
)) {

209 
»p
++;

210 ià(
»p
 == 1000)

211 
	`WBWARN
("too†ongo…rocess‡ll„equests");

212 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(1));

214 
	`´•¬e_¿mbufãr
(
wb
->
cu¼’t_¿mbuf
, wb, wb->
cu¼’t_£g
);

216 
job
 = 
	`mempoŞ_®loc
(
wb
->
æush_job_poŞ
, 
GFP_NOIO
);

217 
	`š™_æush_job
(
job
, 
wb
);

218 
	`INIT_WORK
(&
job
->
wÜk
, 
æush_´oc
);

219 
	`queue_wÜk
(
wb
->
æush”_wq
, &
job
->
wÜk
);

220 
	}
}

222 
	$queue_cu¼’t_bufãr
(
wb_deviû
 *
wb
)

224 
	`queue_æush_job
(
wb
);

225 
	`´•¬e_Ãw_£g
(
wb
);

226 
	}
}

232 
	$æush_cu¼’t_bufãr
(
wb_deviû
 *
wb
)

234 
£gm’t_h—d”
 *
Şd_£g
;

236 
	`mu‹x_lock
(&
wb
->
io_lock
);

237 
Şd_£g
 = 
wb
->
cu¼’t_£g
;

239 
	`queue_cu¼’t_bufãr
(
wb
);

241 
wb
->
cursÜ
 = wb->
cu¼’t_£g
->
¡¬t_idx
;

242 
wb
->
cu¼’t_£g
->
Ëngth
 = 1;

243 
	`mu‹x_uÆock
(&
wb
->
io_lock
);

245 
	`wa™_fÜ_æushšg
(
wb
, 
Şd_£g
->
id
);

246 
	}
}

250 
	$bio_»m­
(
bio
 *bio, 
dm_dev
 *
dev
, 
£ùÜ_t
 
£ùÜ
)

252 
bio
->
bi_bdev
 = 
dev
->
bdev
;

253 
bio
->
bi_£ùÜ
 = 
£ùÜ
;

254 
	}
}

256 
u8
 
	$io_off£t
(
bio
 *bio)

258 
u32
 
tmp32
;

259 
	`div_u64_»m
(
bio
->
bi_£ùÜ
, 1 << 3, &
tmp32
);

260  
tmp32
;

261 
	}
}

263 
£ùÜ_t
 
	$io_couÁ
(
bio
 *bio)

265  
bio
->
bi_size
 >> 
SECTOR_SHIFT
;

266 
	}
}

268 
boŞ
 
	$io_fuÎsize
(
bio
 *bio)

270  
	`io_couÁ
(
bio
) == (1 << 3);

271 
	}
}

276 
£ùÜ_t
 
	$ÿlc_ÿche_®ignm’t
(
£ùÜ_t
 
bio_£ùÜ
)

278  
	`div_u64
(
bio_£ùÜ
, 1 << 3) * (1 << 3);

279 
	}
}

283 
	$šc_¡©
(
wb_deviû
 *
wb
,

284 
rw
, 
boŞ
 
found
, boŞ 
Ú_bufãr
, boŞ 
fuÎsize
)

286 
©omic64_t
 *
v
;

288 
i
 = 0;

289 ià(
rw
)

290 
i
 |ğ(1 << 
STAT_WRITE
);

291 ià(
found
)

292 
i
 |ğ(1 << 
STAT_HIT
);

293 ià(
Ú_bufãr
)

294 
i
 |ğ(1 << 
STAT_ON_BUFFER
);

295 ià(
fuÎsize
)

296 
i
 |ğ(1 << 
STAT_FULLSIZE
);

298 
v
 = &
wb
->
¡©
[
i
];

299 
	`©omic64_šc
(
v
);

300 
	}
}

302 
	$ş—r_¡©
(
wb_deviû
 *
wb
)

304 
size_t
 
i
;

305 
i
 = 0; i < 
STATLEN
; i++) {

306 
©omic64_t
 *
v
 = &
wb
->
¡©
[
i
];

307 
	`©omic64_£t
(
v
, 0);

309 
	}
}

313 
	$šc_Ä_dœty_ÿches
(
wb_deviû
 *
wb
)

315 
	`BUG_ON
(!
wb
);

316 
	`©omic64_šc
(&
wb
->
Ä_dœty_ÿches
);

317 
	}
}

319 
	$dec_Ä_dœty_ÿches
(
wb_deviû
 *
wb
)

321 
	`BUG_ON
(!
wb
);

322 ià(
	`©omic64_dec_ªd_‹¡
(&
wb
->
Ä_dœty_ÿches
))

323 
	`wake_up_š‹¼u±ibË
(&
wb
->
wa™_drİ_ÿches
);

324 
	}
}

329 
	$št_mb
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
,

330 
m‘ablock
 *
mb
, 
bio
 *bio)

332 
æags
;

334 
boŞ
 
was_ş—n
 = 
çl£
;

336 
	`¥š_lock_œq§ve
(&
wb
->
lock
, 
æags
);

337 ià(!
mb
->
dœty_b™s
) {

338 
£g
->
Ëngth
++;

339 
	`BUG_ON
(
£g
->
Ëngth
 > 
wb
->
Ä_ÿches_š£g
);

340 
was_ş—n
 = 
Œue
;

342 ià(
	`lik–y
(
	`io_fuÎsize
(
bio
))) {

343 
mb
->
dœty_b™s
 = 255;

345 
u8
 
i
;

346 
u8
 
acc_b™s
 = 0;

347 
i
 = 
	`io_off£t
(
bio
); i < (io_off£t(bioè+ 
	`io_couÁ
(bio)); i++)

348 
acc_b™s
 +ğ(1 << 
i
);

350 
mb
->
dœty_b™s
 |ğ
acc_b™s
;

352 
	`BUG_ON
(!
	`io_couÁ
(
bio
));

353 
	`BUG_ON
(!
mb
->
dœty_b™s
);

354 
	`¥š_uÆock_œq»¡Üe
(&
wb
->
lock
, 
æags
);

356 ià(
was_ş—n
)

357 
	`šc_Ä_dœty_ÿches
(
wb
);

358 
	}
}

360 
	$ş—nup_mb_if_dœty
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
,

361 
m‘ablock
 *
mb
)

363 
æags
;

365 
boŞ
 
was_dœty
 = 
çl£
;

367 
	`¥š_lock_œq§ve
(&
wb
->
lock
, 
æags
);

368 ià(
mb
->
dœty_b™s
) {

369 
mb
->
dœty_b™s
 = 0;

370 
was_dœty
 = 
Œue
;

372 
	`¥š_uÆock_œq»¡Üe
(&
wb
->
lock
, 
æags
);

374 ià(
was_dœty
)

375 
	`dec_Ä_dœty_ÿches
(
wb
);

376 
	}
}

387 
u8
 
	$»ad_mb_dœtšess
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
,

388 
m‘ablock
 *
mb
)

390 
æags
;

391 
u8
 
v®
;

393 
	`¥š_lock_œq§ve
(&
wb
->
lock
, 
æags
);

394 
v®
 = 
mb
->
dœty_b™s
;

395 
	`¥š_uÆock_œq»¡Üe
(&
wb
->
lock
, 
æags
);

397  
v®
;

398 
	}
}

400 
	$mig¿‹_mb
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
,

401 
m‘ablock
 *
mb
, 
u8
 
dœty_b™s
, 
boŞ
 
th»ad
)

403 
r
 = 0;

405 ià(!
dœty_b™s
)

408 ià(
dœty_b™s
 == 255) {

409 *
buf
 = 
	`mempoŞ_®loc
(
wb
->
buf_8_poŞ
, 
GFP_NOIO
);

410 
dm_io_»que¡
 
io_»q_r
, 
io_»q_w
;

411 
dm_io_»giÚ
 
»giÚ_r
, 
»giÚ_w
;

413 
io_»q_r
 = (
dm_io_»que¡
) {

414 .
ş›Á
 = 
wb_io_ş›Á
,

415 .
bi_rw
 = 
READ
,

416 .
nÙify
.
â
 = 
NULL
,

417 .
mem
.
ty³
 = 
DM_IO_KMEM
,

418 .
mem
.
±r
.
addr
 = 
buf
,

420 
»giÚ_r
 = (
dm_io_»giÚ
) {

421 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

422 .
£ùÜ
 = 
	`ÿlc_mb_¡¬t_£ùÜ
(
wb
, 
£g
, 
mb
->
idx
),

423 .
couÁ
 = (1 << 3),

425 
	`IO
(
	`dm_§ã_io
(&
io_»q_r
, 1, &
»giÚ_r
, 
NULL
, 
th»ad
));

427 
io_»q_w
 = (
dm_io_»que¡
) {

428 .
ş›Á
 = 
wb_io_ş›Á
,

429 .
bi_rw
 = 
WRITE_FUA
,

430 .
nÙify
.
â
 = 
NULL
,

431 .
mem
.
ty³
 = 
DM_IO_KMEM
,

432 .
mem
.
±r
.
addr
 = 
buf
,

434 
»giÚ_w
 = (
dm_io_»giÚ
) {

435 .
bdev
 = 
wb
->
Üigš_dev
->bdev,

436 .
£ùÜ
 = 
mb
->sector,

437 .
couÁ
 = (1 << 3),

439 
	`IO
(
	`dm_§ã_io
(&
io_»q_w
, 1, &
»giÚ_w
, 
NULL
, 
th»ad
));

441 
	`mempoŞ_ä“
(
buf
, 
wb
->
buf_8_poŞ
);

443 *
buf
 = 
	`mempoŞ_®loc
(
wb
->
buf_1_poŞ
, 
GFP_NOIO
);

444 
u8
 
i
;

445 
i
 = 0; i < 8; i++) {

446 
boŞ
 
b™_Ú
 = 
dœty_b™s
 & (1 << 
i
);

447 
dm_io_»que¡
 
io_»q_r
, 
io_»q_w
;

448 
dm_io_»giÚ
 
»giÚ_r
, 
»giÚ_w
;

450 ià(!
b™_Ú
)

453 
io_»q_r
 = (
dm_io_»que¡
) {

454 .
ş›Á
 = 
wb_io_ş›Á
,

455 .
bi_rw
 = 
READ
,

456 .
nÙify
.
â
 = 
NULL
,

457 .
mem
.
ty³
 = 
DM_IO_KMEM
,

458 .
mem
.
±r
.
addr
 = 
buf
,

460 
»giÚ_r
 = (
dm_io_»giÚ
) {

461 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

462 .
£ùÜ
 = 
	`ÿlc_mb_¡¬t_£ùÜ
(
wb
, 
£g
, 
mb
->
idx
è+ 
i
,

463 .
couÁ
 = 1,

465 
	`IO
(
	`dm_§ã_io
(&
io_»q_r
, 1, &
»giÚ_r
, 
NULL
, 
th»ad
));

467 
io_»q_w
 = (
dm_io_»que¡
) {

468 .
ş›Á
 = 
wb_io_ş›Á
,

469 .
bi_rw
 = 
WRITE
,

470 .
nÙify
.
â
 = 
NULL
,

471 .
mem
.
ty³
 = 
DM_IO_KMEM
,

472 .
mem
.
±r
.
addr
 = 
buf
,

474 
»giÚ_w
 = (
dm_io_»giÚ
) {

475 .
bdev
 = 
wb
->
Üigš_dev
->bdev,

476 .
£ùÜ
 = 
mb
->£ùÜ + 
i
,

477 .
couÁ
 = 1,

479 
	`IO
(
	`dm_§ã_io
(&
io_»q_w
, 1, &
»giÚ_w
, 
NULL
, 
th»ad
));

481 
	`mempoŞ_ä“
(
buf
, 
wb
->
buf_1_poŞ
);

483 
	}
}

489 
	$mig¿‹_bufã»d_mb
(
wb_deviû
 *
wb
,

490 
m‘ablock
 *
mb
, 
u8
 
dœty_b™s
)

492 
r
 = 0;

494 
£ùÜ_t
 
off£t
 = ((
	`mb_idx_š£g
(
wb
, 
mb
->
idx
) + 1) << 3);

495 *
buf
 = 
	`mempoŞ_®loc
(
wb
->
buf_1_poŞ
, 
GFP_NOIO
);

497 
u8
 
i
;

498 
i
 = 0; i < 8; i++) {

499 
dm_io_»que¡
 
io_»q
;

500 
dm_io_»giÚ
 
»giÚ
;

501 *
¤c
;

502 
£ùÜ_t
 
de¡
;

504 
boŞ
 
b™_Ú
 = 
dœty_b™s
 & (1 << 
i
);

505 ià(!
b™_Ú
)

508 
¤c
 = 
wb
->
cu¼’t_¿mbuf
->
d©a
 +

509 ((
off£t
 + 
i
è<< 
SECTOR_SHIFT
);

510 
	`memıy
(
buf
, 
¤c
, 1 << 
SECTOR_SHIFT
);

512 
io_»q
 = (
dm_io_»que¡
) {

513 .
ş›Á
 = 
wb_io_ş›Á
,

514 .
bi_rw
 = 
WRITE_FUA
,

515 .
nÙify
.
â
 = 
NULL
,

516 .
mem
.
ty³
 = 
DM_IO_KMEM
,

517 .
mem
.
±r
.
addr
 = 
buf
,

520 
de¡
 = 
mb
->
£ùÜ
 + 
i
;

521 
»giÚ
 = (
dm_io_»giÚ
) {

522 .
bdev
 = 
wb
->
Üigš_dev
->bdev,

523 .
£ùÜ
 = 
de¡
,

524 .
couÁ
 = 1,

527 
	`IO
(
	`dm_§ã_io
(&
io_»q
, 1, &
»giÚ
, 
NULL
, 
Œue
));

529 
	`mempoŞ_ä“
(
buf
, 
wb
->
buf_1_poŞ
);

530 
	}
}

532 
	$šv®id©e_´evious_ÿche
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
,

533 
m‘ablock
 *
Şd_mb
, 
boŞ
 
ov”wr™e_fuÎsize
)

535 
u8
 
dœty_b™s
 = 
	`»ad_mb_dœtšess
(
wb
, 
£g
, 
Şd_mb
);

540 
boŞ
 
Ãeds_ş—nup_´ev_ÿche
 =

541 !
ov”wr™e_fuÎsize
 || !(
dœty_b™s
 == 255);

547 ià(!
dœty_b™s
)

548 
Ãeds_ş—nup_´ev_ÿche
 = 
çl£
;

550 ià(
ov”wr™e_fuÎsize
)

551 
Ãeds_ş—nup_´ev_ÿche
 = 
çl£
;

553 ià(
	`uÆik–y
(
Ãeds_ş—nup_´ev_ÿche
)) {

554 
	`wa™_fÜ_æushšg
(
wb
, 
£g
->
id
);

555 
	`mig¿‹_mb
(
wb
, 
£g
, 
Şd_mb
, 
dœty_b™s
, 
Œue
);

558 
	`ş—nup_mb_if_dœty
(
wb
, 
£g
, 
Şd_mb
);

560 
	`ht_d–
(
wb
, 
Şd_mb
);

561 
	}
}

564 
	$wr™e_Ú_bufãr
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
,

565 
m‘ablock
 *
mb
, 
bio
 *bio)

567 
£ùÜ_t
 
¡¬t_£ùÜ
 = ((
	`mb_idx_š£g
(
wb
, 
mb
->
idx
) + 1) << 3) +

568 
	`io_off£t
(
bio
);

569 
size_t
 
¡¬t_by‹
 = 
¡¬t_£ùÜ
 << 
SECTOR_SHIFT
;

570 *
d©a
 = 
	`bio_d©a
(
bio
);

575 
	`memıy
(
wb
->
cu¼’t_¿mbuf
->
d©a
 + 
¡¬t_by‹
, d©a, 
bio
->
bi_size
);

576 
	}
}

578 
	$advªû_cursÜ
(
wb_deviû
 *
wb
)

580 
u32
 
tmp32
;

581 
	`div_u64_»m
(
wb
->
cursÜ
 + 1, wb->
Ä_ÿches
, &
tmp32
);

582 
wb
->
cursÜ
 = 
tmp32
;

583 
	}
}

585 
	s³r_bio_d©a
 {

586 *
	m±r
;

589 
	$wr™eboo¡_m­
(
dm_rg‘
 *
ti
, 
bio
 *bio)

591 
wb_deviû
 *
wb
 = 
ti
->
´iv©e
;

592 
dm_dev
 *
Üigš_dev
 = 
wb
->origin_dev;

593 
rw
 = 
	`bio_d©a_dœ
(
bio
);

594 
lookup_key
 
key
 = {

595 .
£ùÜ
 = 
	`ÿlc_ÿche_®ignm’t
(
bio
->
bi_£ùÜ
),

597 
ht_h—d
 *
h—d
 = 
	`ht_g‘_h—d
(
wb
, &
key
);

599 
£gm’t_h—d”
 *
	`unš™Ÿlized_v¬
(
found_£g
);

600 
m‘ablock
 *
mb
, *
Ãw_mb
;

602 
boŞ
 
found
,

603 
Ú_bufãr
,

604 
Ãed_queue_£g
;

606 
³r_bio_d©a
 *
m­_cÚ‹xt
;

607 
m­_cÚ‹xt
 = 
	`dm_³r_bio_d©a
(
bio
, 
ti
->
³r_bio_d©a_size
);

608 
m­_cÚ‹xt
->
±r
 = 
NULL
;

610 
	`DEAD
(
	`bio_’dio
(
bio
, -
EIO
);  
DM_MAPIO_SUBMITTED
);

620 ià(
bio
->
bi_rw
 & 
REQ_DISCARD
) {

621 
	`bio_»m­
(
bio
, 
Üigš_dev
, bio->
bi_£ùÜ
);

622  
DM_MAPIO_REMAPPED
;

631 ià(
bio
->
bi_rw
 & 
REQ_FLUSH
) {

632 
	`BUG_ON
(
bio
->
bi_size
);

633 
	`queue_b¬r›r_io
(
wb
, 
bio
);

634  
DM_MAPIO_SUBMITTED
;

637 
	`mu‹x_lock
(&
wb
->
io_lock
);

638 
mb
 = 
	`ht_lookup
(
wb
, 
h—d
, &
key
);

639 ià(
mb
) {

640 
found_£g
 = 
	`mb_to_£g
(
wb
, 
mb
);

641 
	`©omic_šc
(&
found_£g
->
Ä_šæight_ios
);

644 
found
 = (
mb
 !ğ
NULL
);

645 
Ú_bufãr
 = 
çl£
;

646 ià(
found
)

647 
Ú_bufãr
 = 
	`is_Ú_bufãr
(
wb
, 
mb
->
idx
);

649 
	`šc_¡©
(
wb
, 
rw
, 
found
, 
Ú_bufãr
, 
	`io_fuÎsize
(
bio
));

667 ià(!
rw
) {

668 
u8
 
dœty_b™s
;

670 
	`mu‹x_uÆock
(&
wb
->
io_lock
);

672 ià(!
found
) {

673 
	`bio_»m­
(
bio
, 
Üigš_dev
, bio->
bi_£ùÜ
);

674  
DM_MAPIO_REMAPPED
;

677 
dœty_b™s
 = 
	`»ad_mb_dœtšess
(
wb
, 
found_£g
, 
mb
);

678 ià(
	`uÆik–y
(
Ú_bufãr
)) {

679 ià(
dœty_b™s
)

680 
	`mig¿‹_bufã»d_mb
(
wb
, 
mb
, 
dœty_b™s
);

682 
	`©omic_dec
(&
found_£g
->
Ä_šæight_ios
);

683 
	`bio_»m­
(
bio
, 
Üigš_dev
, bio->
bi_£ùÜ
);

684  
DM_MAPIO_REMAPPED
;

692 
	`wa™_fÜ_æushšg
(
wb
, 
found_£g
->
id
);

694 ià(
	`lik–y
(
dœty_b™s
 == 255)) {

695 
	`bio_»m­
(
bio
, 
wb
->
ÿche_dev
,

696 
	`ÿlc_mb_¡¬t_£ùÜ
(
wb
, 
found_£g
, 
mb
->
idx
) +

697 
	`io_off£t
(
bio
));

698 
m­_cÚ‹xt
->
±r
 = 
found_£g
;

700 
	`mig¿‹_mb
(
wb
, 
found_£g
, 
mb
, 
dœty_b™s
, 
Œue
);

701 
	`ş—nup_mb_if_dœty
(
wb
, 
found_£g
, 
mb
);

703 
	`©omic_dec
(&
found_£g
->
Ä_šæight_ios
);

704 
	`bio_»m­
(
bio
, 
Üigš_dev
, bio->
bi_£ùÜ
);

706  
DM_MAPIO_REMAPPED
;

709 ià(
found
) {

710 ià(
	`uÆik–y
(
Ú_bufãr
)) {

711 
	`mu‹x_uÆock
(&
wb
->
io_lock
);

712 
wr™e_Ú_bufãr
;

714 
	`šv®id©e_´evious_ÿche
(
wb
, 
found_£g
, 
mb
,

715 
	`io_fuÎsize
(
bio
));

716 
	`©omic_dec
(&
found_£g
->
Ä_šæight_ios
);

717 
wr™e_nÙ_found
;

721 
wr™e_nÙ_found
:

727 
Ãed_queue_£g
 = !
	`mb_idx_š£g
(
wb
, wb->
cursÜ
 + 1);

729 ià(
Ãed_queue_£g
)

730 
	`queue_cu¼’t_bufãr
(
wb
);

732 
	`advªû_cursÜ
(
wb
);

734 
Ãw_mb
 = 
wb
->
cu¼’t_£g
->
mb_¬¿y
 + 
	`mb_idx_š£g
(wb, wb->
cursÜ
);

735 
Ãw_mb
->
dœty_b™s
 = 0;

736 
	`ht_»gi¡”
(
wb
, 
h—d
, &
key
, 
Ãw_mb
);

738 
	`©omic_šc
(&
wb
->
cu¼’t_£g
->
Ä_šæight_ios
);

739 
	`mu‹x_uÆock
(&
wb
->
io_lock
);

741 
mb
 = 
Ãw_mb
;

743 
wr™e_Ú_bufãr
:

744 
	`št_mb
(
wb
, wb->
cu¼’t_£g
, 
mb
, 
bio
);

746 
	`wr™e_Ú_bufãr
(
wb
, wb->
cu¼’t_£g
, 
mb
, 
bio
);

748 
	`©omic_dec
(&
wb
->
cu¼’t_£g
->
Ä_šæight_ios
);

757 ià(
bio
->
bi_rw
 & 
REQ_FUA
) {

758 
	`queue_b¬r›r_io
(
wb
, 
bio
);

759  
DM_MAPIO_SUBMITTED
;

762 
	`LIVE_DEAD
(

763 
	`bio_’dio
(
bio
, 0),

764 
	`bio_’dio
(
bio
, -
EIO
));

766  
DM_MAPIO_SUBMITTED
;

767 
	}
}

769 
	$wr™eboo¡_’d_io
(
dm_rg‘
 *
ti
, 
bio
 *bio, 
”rÜ
)

771 
£gm’t_h—d”
 *
£g
;

772 
³r_bio_d©a
 *
m­_cÚ‹xt
 =

773 
	`dm_³r_bio_d©a
(
bio
, 
ti
->
³r_bio_d©a_size
);

775 ià(!
m­_cÚ‹xt
->
±r
)

778 
£g
 = 
m­_cÚ‹xt
->
±r
;

779 
	`©omic_dec
(&
£g
->
Ä_šæight_ios
);

782 
	}
}

784 
	$cÚsume_es£ÁŸl_¬gv
(
wb_deviû
 *
wb
, 
dm_¬g_£t
 *
as
)

786 
r
 = 0;

787 
dm_rg‘
 *
ti
 = 
wb
->ti;

789 
dm_¬g
 
_¬gs
[] = {

792 
tmp
;

794 
r
 = 
	`dm_»ad_¬g
(
_¬gs
, 
as
, &
tmp
, &
ti
->
”rÜ
);

795 ià(
r
)

796  
r
;

797 
wb
->
ty³
 = 
tmp
;

799 
r
 = 
	`dm_g‘_deviû
(
ti
, 
	`dm_shiá_¬g
(
as
), 
	`dm_bË_g‘_mode
Ñi->
bË
),

800 &
wb
->
Üigš_dev
);

801 ià(
r
) {

802 
ti
->
”rÜ
 = "failedo get origin dev";

803  
r
;

806 
r
 = 
	`dm_g‘_deviû
(
ti
, 
	`dm_shiá_¬g
(
as
), 
	`dm_bË_g‘_mode
Ñi->
bË
),

807 &
wb
->
ÿche_dev
);

808 ià(
r
) {

809 
ti
->
”rÜ
 = "failedo get cache dev";

810 
bad
;

813  
r
;

815 
bad
:

816 
	`dm_put_deviû
(
ti
, 
wb
->
Üigš_dev
);

817  
r
;

818 
	}
}

820 
	#cÚsume_kv
(
Çme
, 
Ä
) { \

821 ià(!
	`¡rÿ£cmp
(
key
, #name)) { \

822 ià(!
¬gc
) \

824 
r
 = 
	`dm_»ad_¬g
(
_¬gs
 + (
Ä
), 
as
, &
tmp
, &
ti
->
”rÜ
); \

825 ià(
r
) \

827 
wb
->
Çme
 = 
tmp
; \

828 } }

	)

830 
	$cÚsume_İtiÚ®_¬gv
(
wb_deviû
 *
wb
, 
dm_¬g_£t
 *
as
)

832 
r
 = 0;

833 
dm_rg‘
 *
ti
 = 
wb
->ti;

835 
dm_¬g
 
_¬gs
[] = {

838 {512, 
UINT_MAX
, "invalid„ambuf_pool_amount"},

840 
tmp
, 
¬gc
 = 0;

842 ià(
as
->
¬gc
) {

843 
r
 = 
	`dm_»ad_¬g_group
(
_¬gs
, 
as
, &
¬gc
, &
ti
->
”rÜ
);

844 ià(
r
)

845  
r
;

848 
¬gc
) {

849 cÚ¡ *
key
 = 
	`dm_shiá_¬g
(
as
);

850 
¬gc
--;

852 
r
 = -
EINVAL
;

854 
	`cÚsume_kv
(
£gm’t_size_Üd”
, 1);

855 
	`cÚsume_kv
(
¿mbuf_poŞ_amouÁ
, 2);

857 ià(!
r
) {

858 
¬gc
--;

860 
ti
->
”rÜ
 = "invalid optional key";

865  
r
;

866 
	}
}

868 
	$do_cÚsume_tuÇbË_¬gv
(
wb_deviû
 *
wb
,

869 
dm_¬g_£t
 *
as
, 
¬gc
)

871 
r
 = 0;

872 
dm_rg‘
 *
ti
 = 
wb
->ti;

874 
dm_¬g
 
_¬gs
[] = {

883 
tmp
;

885 
¬gc
) {

886 cÚ¡ *
key
 = 
	`dm_shiá_¬g
(
as
);

887 
¬gc
--;

889 
r
 = -
EINVAL
;

891 
	`cÚsume_kv
(
®low_mig¿‹
, 0);

892 
	`cÚsume_kv
(
’abË_mig¿tiÚ_moduÏtÜ
, 1);

893 
	`cÚsume_kv
(
b¬r›r_d—dlše_ms
, 2);

894 
	`cÚsume_kv
(
Ä_max_b©ched_mig¿tiÚ
, 3);

895 
	`cÚsume_kv
(
mig¿‹_th»shŞd
, 4);

896 
	`cÚsume_kv
(
upd©e_»cÜd_š‹rv®
, 5);

897 
	`cÚsume_kv
(
sync_š‹rv®
, 6);

899 ià(!
r
) {

900 
¬gc
--;

902 
ti
->
”rÜ
 = "invalid optional key";

907  
r
;

908 
	}
}

910 
	$cÚsume_tuÇbË_¬gv
(
wb_deviû
 *
wb
, 
dm_¬g_£t
 *
as
)

912 
r
 = 0;

913 
dm_rg‘
 *
ti
 = 
wb
->ti;

915 
dm_¬g
 
_¬gs
[] = {

918 
¬gc
 = 0;

920 ià(
as
->
¬gc
) {

921 
r
 = 
	`dm_»ad_¬g_group
(
_¬gs
, 
as
, &
¬gc
, &
ti
->
”rÜ
);

922 ià(
r
)

923  
r
;

928 
wb
->
should_em™_tuÇbËs
 = 
Œue
;

931  
	`do_cÚsume_tuÇbË_¬gv
(
wb
, 
as
, 
¬gc
);

932 
	}
}

934 
	$š™_cÜe_¡ruù
(
dm_rg‘
 *
ti
)

936 
r
 = 0;

937 
wb_deviû
 *
wb
;

939 
r
 = 
	`dm_£t_rg‘_max_io_Ën
(
ti
, 1 << 3);

940 ià(
r
) {

941 
	`WBERR
("failedo set max_io_len");

942  
r
;

945 
ti
->
æush_suµÜ‹d
 = 
Œue
;

946 
ti
->
num_æush_bios
 = 1;

947 
ti
->
num_disÿrd_bios
 = 1;

948 
ti
->
disÿrd_z”Ûs_d©a_unsuµÜ‹d
 = 
Œue
;

949 
ti
->
³r_bio_d©a_size
 = (
³r_bio_d©a
);

951 
wb
 = 
	`kz®loc
((*wb), 
GFP_KERNEL
);

952 ià(!
wb
) {

953 
	`WBERR
("failedo‡llocate wb");

954  -
ENOMEM
;

956 
ti
->
´iv©e
 = 
wb
;

957 
wb
->
ti
 =i;

959 
	`¥š_lock_š™
(&
wb
->
lock
);

960 
	`©omic64_£t
(&
wb
->
Ä_dœty_ÿches
, 0);

961 
	`ş—r_b™
(
WB_DEAD
, &
wb
->
æags
);

962 
wb
->
should_em™_tuÇbËs
 = 
çl£
;

964  
r
;

965 
	}
}

978 
	$wr™eboo¡_ùr
(
dm_rg‘
 *
ti
, 
¬gc
, **
¬gv
)

980 
r
 = 0;

981 
wb_deviû
 *
wb
;

983 
dm_¬g_£t
 
as
;

984 
as
.
¬gc
 =‡rgc;

985 
as
.
¬gv
 =‡rgv;

987 
r
 = 
	`š™_cÜe_¡ruù
(
ti
);

988 ià(
r
) {

989 
ti
->
”rÜ
 = "failedo init core";

990  
r
;

992 
wb
 = 
ti
->
´iv©e
;

994 
r
 = 
	`cÚsume_es£ÁŸl_¬gv
(
wb
, &
as
);

995 ià(
r
) {

996 
ti
->
”rÜ
 = "failedo consumeƒssential‡rgv";

997 
bad_es£ÁŸl_¬gv
;

1000 
wb
->
£gm’t_size_Üd”
 = 7;

1001 
wb
->
¿mbuf_poŞ_amouÁ
 = 2048;

1002 
r
 = 
	`cÚsume_İtiÚ®_¬gv
(
wb
, &
as
);

1003 ià(
r
) {

1004 
ti
->
”rÜ
 = "failedo consume optional‡rgv";

1005 
bad_İtiÚ®_¬gv
;

1008 
r
 = 
	`»sume_ÿche
(
wb
);

1009 ià(
r
) {

1010 
ti
->
”rÜ
 = "failedo„esume cache";

1011 
bad_»sume_ÿche
;

1014 
r
 = 
	`cÚsume_tuÇbË_¬gv
(
wb
, &
as
);

1015 ià(
r
) {

1016 
ti
->
”rÜ
 = "failedo consumeunable‡rgv";

1017 
bad_tuÇbË_¬gv
;

1020 
	`ş—r_¡©
(
wb
);

1021 
	`©omic64_£t
(&
wb
->
couÁ_nÚ_fuÎ_æushed
, 0);

1023  
r
;

1025 
bad_tuÇbË_¬gv
:

1026 
	`ä“_ÿche
(
wb
);

1027 
bad_»sume_ÿche
:

1028 
bad_İtiÚ®_¬gv
:

1029 
	`dm_put_deviû
(
ti
, 
wb
->
ÿche_dev
);

1030 
	`dm_put_deviû
(
ti
, 
wb
->
Üigš_dev
);

1031 
bad_es£ÁŸl_¬gv
:

1032 
	`kä“
(
wb
);

1034  
r
;

1035 
	}
}

1037 
	$wr™eboo¡_dŒ
(
dm_rg‘
 *
ti
)

1039 
wb_deviû
 *
wb
 = 
ti
->
´iv©e
;

1041 
	`ä“_ÿche
(
wb
);

1043 
	`dm_put_deviû
(
ti
, 
wb
->
ÿche_dev
);

1044 
	`dm_put_deviû
(
ti
, 
wb
->
Üigš_dev
);

1046 
	`kä“
(
wb
);

1048 
ti
->
´iv©e
 = 
NULL
;

1049 
	}
}

1055 
	$wr™eboo¡_po¡su¥’d
(
dm_rg‘
 *
ti
)

1057 
r
 = 0;

1058 
wb_deviû
 *
wb
 = 
ti
->
´iv©e
;

1060 
	`æush_cu¼’t_bufãr
(
wb
);

1061 
	`IO
(
	`blkdev_issue_æush
(
wb
->
ÿche_dev
->
bdev
, 
GFP_NOIO
, 
NULL
));

1062 
	}
}

1064 
	$wr™eboo¡_»sume
(
dm_rg‘
 *
ti
è{
	}
}

1066 
	$wr™eboo¡_mes§ge
(
dm_rg‘
 *
ti
, 
¬gc
, **
¬gv
)

1068 
wb_deviû
 *
wb
 = 
ti
->
´iv©e
;

1070 
dm_¬g_£t
 
as
;

1071 
as
.
¬gc
 =‡rgc;

1072 
as
.
¬gv
 =‡rgv;

1074 ià(!
	`¡rÿ£cmp
(
¬gv
[0], "clear_stat")) {

1075 
	`ş—r_¡©
(
wb
);

1079 ià(!
	`¡rÿ£cmp
(
¬gv
[0], "drop_caches")) {

1080  
	`wa™_ev’t_š‹¼u±ibË
(
wb
->
wa™_drİ_ÿches
,

1081 !
	`©omic64_»ad
(&
wb
->
Ä_dœty_ÿches
));

1084  
	`do_cÚsume_tuÇbË_¬gv
(
wb
, &
as
, 2);

1085 
	}
}

1087 
	$wr™eboo¡_m”ge
(
dm_rg‘
 *
ti
, 
bvec_m”ge_d©a
 *
bvm
,

1088 
bio_vec
 *
biovec
, 
max_size
)

1090 
wb_deviû
 *
wb
 = 
ti
->
´iv©e
;

1091 
dm_dev
 *
deviû
 = 
wb
->
Üigš_dev
;

1092 
»que¡_queue
 *
q
 = 
	`bdev_g‘_queue
(
deviû
->
bdev
);

1094 ià(!
q
->
m”ge_bvec_â
)

1095  
max_size
;

1097 
bvm
->
bi_bdev
 = 
deviû
->
bdev
;

1098  
	`mš
(
max_size
, 
q
->
	`m”ge_bvec_â
(q, 
bvm
, 
biovec
));

1099 
	}
}

1101 
	$wr™eboo¡_™”©e_deviûs
(
dm_rg‘
 *
ti
,

1102 
™”©e_deviûs_ÿÎout_â
 
â
, *
d©a
)

1104 
wb_deviû
 *
wb
 = 
ti
->
´iv©e
;

1105 
dm_dev
 *
Üig
 = 
wb
->
Üigš_dev
;

1106 
£ùÜ_t
 
¡¬t
 = 0;

1107 
£ùÜ_t
 
Ën
 = 
	`dm_devsize
(
Üig
);

1108  
	`â
(
ti
, 
Üig
, 
¡¬t
, 
Ën
, 
d©a
);

1109 
	}
}

1112 
	$wr™eboo¡_io_hšts
(
dm_rg‘
 *
ti
, 
queue_lim™s
 *
lim™s
)

1114 
	`blk_lim™s_io_mš
(
lim™s
, 512);

1115 
	`blk_lim™s_io_İt
(
lim™s
, 4096);

1116 
	}
}

1118 
	$em™_tuÇbËs
(
wb_deviû
 *
wb
, *
»suÉ
, 
maxËn
)

1120 
ssize_t
 
sz
 = 0;

1122 
	`DMEMIT
(" %d", 14);

1123 
	`DMEMIT
(" barrier_deadline_ms %lu",

1124 
wb
->
b¬r›r_d—dlše_ms
);

1125 
	`DMEMIT
("‡llow_migrate %d",

1126 
wb
->
®low_mig¿‹
 ? 1 : 0);

1127 
	`DMEMIT
("ƒnable_migration_modulator %d",

1128 
wb
->
’abË_mig¿tiÚ_moduÏtÜ
 ? 1 : 0);

1129 
	`DMEMIT
(" migrate_threshold %d",

1130 
wb
->
mig¿‹_th»shŞd
);

1131 
	`DMEMIT
("‚r_cur_batched_migration %u",

1132 
wb
->
Ä_cur_b©ched_mig¿tiÚ
);

1133 
	`DMEMIT
(" sync_interval %lu",

1134 
wb
->
sync_š‹rv®
);

1135 
	`DMEMIT
(" update_record_interval %lu",

1136 
wb
->
upd©e_»cÜd_š‹rv®
);

1137 
	}
}

1139 
	$wr™eboo¡_¡©us
(
dm_rg‘
 *
ti
, 
¡©us_ty³_t
 
ty³
,

1140 
æags
, *
»suÉ
, 
maxËn
)

1142 
ssize_t
 
sz
 = 0;

1143 
buf
[
BDEVNAME_SIZE
];

1144 
wb_deviû
 *
wb
 = 
ti
->
´iv©e
;

1145 
size_t
 
i
;

1147 
ty³
) {

1148 
STATUSTYPE_INFO
:

1149 
	`DMEMIT
("%u %u %llu %llu %llu %llu %llu",

1151 
wb
->
cursÜ
,

1153 
wb
->
Ä_ÿches
,

1155 
wb
->
Ä_£gm’ts
,

1157 
wb
->
cu¼’t_£g
->
id
,

1159 
	`©omic64_»ad
(&
wb
->
Ï¡_æushed_£gm’t_id
),

1161 
	`©omic64_»ad
(&
wb
->
Ï¡_mig¿‹d_£gm’t_id
),

1163 
	`©omic64_»ad
(&
wb
->
Ä_dœty_ÿches
));

1165 
i
 = 0; i < 
STATLEN
; i++) {

1166 
©omic64_t
 *
v
 = &
wb
->
¡©
[
i
];

1167 
	`DMEMIT
(" %Îu", (è
	`©omic64_»ad
(
v
));

1169 
	`DMEMIT
(" %Îu", (è
	`©omic64_»ad
(&
wb
->
couÁ_nÚ_fuÎ_æushed
));

1170 
	`em™_tuÇbËs
(
wb
, 
»suÉ
 + 
sz
, 
maxËn
 - sz);

1173 
STATUSTYPE_TABLE
:

1174 
	`DMEMIT
("0");

1175 
	`fÜm©_dev_t
(
buf
, 
wb
->
Üigš_dev
->
bdev
->
bd_dev
),

1176 
	`DMEMIT
(" %s", 
buf
);

1177 
	`fÜm©_dev_t
(
buf
, 
wb
->
ÿche_dev
->
bdev
->
bd_dev
),

1178 
	`DMEMIT
(" %s", 
buf
);

1179 
	`DMEMIT
(" 4 segment_size_order %u„ambuf_pool_amount %u",

1180 
wb
->
£gm’t_size_Üd”
,

1181 
wb
->
¿mbuf_poŞ_amouÁ
);

1182 ià(
wb
->
should_em™_tuÇbËs
)

1183 
	`em™_tuÇbËs
(
wb
, 
»suÉ
 + 
sz
, 
maxËn
 - sz);

1186 
	}
}

1188 
rg‘_ty³
 
	gwr™eboo¡_rg‘
 = {

1189 .
Çme
 = "writeboost",

1190 .
	gv”siÚ
 = {0, 1, 0},

1191 .
	gmoduË
 = 
THIS_MODULE
,

1192 .
	gm­
 = 
wr™eboo¡_m­
,

1193 .
	g’d_io
 = 
wr™eboo¡_’d_io
,

1194 .
	gùr
 = 
wr™eboo¡_ùr
,

1195 .
	gdŒ
 = 
wr™eboo¡_dŒ
,

1196 .
	gpo¡su¥’d
 = 
wr™eboo¡_po¡su¥’d
,

1197 .
	g»sume
 = 
wr™eboo¡_»sume
,

1198 .
	gm”ge
 = 
wr™eboo¡_m”ge
,

1199 .
	gmes§ge
 = 
wr™eboo¡_mes§ge
,

1200 .
	g¡©us
 = 
wr™eboo¡_¡©us
,

1201 .
	gio_hšts
 = 
wr™eboo¡_io_hšts
,

1202 .
	g™”©e_deviûs
 = 
wr™eboo¡_™”©e_deviûs
,

1205 
dm_io_ş›Á
 *
	gwb_io_ş›Á
;

1206 
wÜkqueue_¡ruù
 *
	g§ã_io_wq
;

1207 
__š™
 
	$wr™eboo¡_moduË_š™
()

1209 
r
 = 0;

1211 
r
 = 
	`dm_»gi¡”_rg‘
(&
wr™eboo¡_rg‘
);

1212 ià(
r
 < 0) {

1213 
	`WBERR
("failedo„egisterarget");

1214  
r
;

1217 
§ã_io_wq
 = 
	`®loc_wÜkqueue
("wbsafeiowq",

1218 
WQ_NON_REENTRANT
 | 
WQ_MEM_RECLAIM
, 0);

1219 ià(!
§ã_io_wq
) {

1220 
	`WBERR
("failedo‡llocate safe_io_wq");

1221 
r
 = -
ENOMEM
;

1222 
bad_wq
;

1225 
wb_io_ş›Á
 = 
	`dm_io_ş›Á_ü—‹
();

1226 ià(
	`IS_ERR
(
wb_io_ş›Á
)) {

1227 
	`WBERR
("failedo‡llocate wb_io_client");

1228 
r
 = 
	`PTR_ERR
(
wb_io_ş›Á
);

1229 
bad_io_ş›Á
;

1232  
r
;

1234 
bad_io_ş›Á
:

1235 
	`de¡roy_wÜkqueue
(
§ã_io_wq
);

1236 
bad_wq
:

1237 
	`dm_uÄegi¡”_rg‘
(&
wr™eboo¡_rg‘
);

1239  
r
;

1240 
	}
}

1242 
__ex™
 
	$wr™eboo¡_moduË_ex™
()

1244 
	`dm_io_ş›Á_de¡roy
(
wb_io_ş›Á
);

1245 
	`de¡roy_wÜkqueue
(
§ã_io_wq
);

1246 
	`dm_uÄegi¡”_rg‘
(&
wr™eboo¡_rg‘
);

1247 
	}
}

1249 
moduË_š™
(
wr™eboo¡_moduË_š™
);

1250 
moduË_ex™
(
wr™eboo¡_moduË_ex™
);

1252 
MODULE_AUTHOR
("Akira Hayakawa <ruby.wktk@gmail.com>");

1253 
MODULE_DESCRIPTION
(
DM_NAME
 " writeboostarget");

1254 
MODULE_LICENSE
("GPL");

	@dm-writeboost.h

7 #iâdeà
DM_WRITEBOOST_H


8 
	#DM_WRITEBOOST_H


	)

10 
	#DM_MSG_PREFIX
 "wr™eboo¡"

	)

12 
	~<lšux/moduË.h
>

13 
	~<lšux/v”siÚ.h
>

14 
	~<lšux/li¡.h
>

15 
	~<lšux/¦ab.h
>

16 
	~<lšux/vm®loc.h
>

17 
	~<lšux/mu‹x.h
>

18 
	~<lšux/kth»ad.h
>

19 
	~<lšux/sched.h
>

20 
	~<lšux/tim”.h
>

21 
	~<lšux/wÜkqueue.h
>

22 
	~<lšux/deviû-m­³r.h
>

23 
	~<lšux/dm-io.h
>

27 
	#SUB_ID
(
x
, 
y
è(xè> (yè? (xè- (yè: 0

	)

42 
	#wbdebug
(
f
, 
¬gs
...) \

43 
	`DMINFO
("debug@%s(èL.%d " 
f
, 
__func__
, 
__LINE__
, ## 
¬gs
)

	)

45 
	#WBERR
(
f
, 
¬gs
...) \

46 
	`DMERR
("”r@%s(è" 
f
, 
__func__
, ## 
¬gs
)

	)

47 
	#WBWARN
(
f
, 
¬gs
...) \

48 
	`DMWARN
("w¬n@%s(è" 
f
, 
__func__
, ## 
¬gs
)

	)

49 
	#WBINFO
(
f
, 
¬gs
...) \

50 
	`DMINFO
("šfo@%s(è" 
f
, 
__func__
, ## 
¬gs
)

	)

79 
	#WB_MAGIC
 0x57427374

	)

80 
	ssu³rblock_h—d”_deviû
 {

81 
__Ë32
 
	mmagic
;

82 
__u8
 
	m£gm’t_size_Üd”
;

83 } 
	g__·cked
;

91 
	ssu³rblock_»cÜd_deviû
 {

92 
__Ë64
 
	mÏ¡_mig¿‹d_£gm’t_id
;

93 } 
	g__·cked
;

102 
	sm‘ablock_deviû
 {

103 
__Ë64
 
	m£ùÜ
;

104 
__u8
 
	mdœty_b™s
;

105 
__u8
 
	m·ddšg
[16 - (8 + 1)];

106 } 
	g__·cked
;

108 
	#WB_CKSUM_SEED
 (~(
u32
)0)

	)

110 
	s£gm’t_h—d”_deviû
 {

119 
__Ë64
 
	mid
;

121 
__Ë32
 
	mchecksum
;

126 
__u8
 
	mËngth
;

127 
__u8
 
	m·ddšg
[512 - (8 + 4 + 1)];

129 
m‘ablock_deviû
 
	mmb¬r
[0];

130 } 
	g__·cked
;

134 
	sm‘ablock
 {

135 
£ùÜ_t
 
	m£ùÜ
;

137 
u32
 
	midx
;

139 
hli¡_node
 
	mht_li¡
;

141 
u8
 
	mdœty_b™s
;

144 
	#SZ_MAX
 (~(
size_t
)0)

	)

145 
	s£gm’t_h—d”
 {

146 
u64
 
	mid
;

152 
u8
 
	mËngth
;

154 
u32
 
	m¡¬t_idx
;

155 
£ùÜ_t
 
	m¡¬t_£ùÜ
;

157 
©omic_t
 
	mÄ_šæight_ios
;

159 
m‘ablock
 
	mmb_¬¿y
[0];

164 
	eRAMBUF_TYPE
 {

165 
	mBUF_NORMAL
 = 0,

166 
	mBUF_NV_BLK
,

167 
	mBUF_NV_RAM
,

174 
	s¿mbufãr
 {

175 *
	md©a
;

183 
	sæush_job
 {

184 
wÜk_¡ruù
 
	mwÜk
;

185 
wb_deviû
 *
	mwb
;

186 
£gm’t_h—d”
 *
	m£g
;

187 
¿mbufãr
 *
	m¿mbuf
;

188 
bio_li¡
 
	mb¬r›r_ios
;

193 
	eSTATFLAG
 {

194 
	mSTAT_WRITE
 = 0,

195 
	mSTAT_HIT
,

196 
	mSTAT_ON_BUFFER
,

197 
	mSTAT_FULLSIZE
,

199 
	#STATLEN
 (1 << 4)

	)

201 
	eWB_FLAG
 {

207 
	mWB_DEAD
 = 0,

213 
	swb_deviû
 {

214 
RAMBUF_TYPE
 
	mty³
;

216 
dm_rg‘
 *
	mti
;

218 
dm_dev
 *
	mÜigš_dev
;

219 
dm_dev
 *
	mÿche_dev
;

221 
mempoŞ_t
 *
	mbuf_1_poŞ
;

222 
mempoŞ_t
 *
	mbuf_8_poŞ
;

231 
mu‹x
 
	mio_lock
;

233 
¥šlock_t
 
	mlock
;

235 
u8
 
	m£gm’t_size_Üd”
;

236 
u8
 
	mÄ_ÿches_š£g
;

249 
u32
 
	mcursÜ
;

250 
£gm’t_h—d”
 *
	mcu¼’t_£g
;

251 
¿mbufãr
 *
	mcu¼’t_¿mbuf
;

259 
u32
 
	mÄ_£gm’ts
;

260 
Ïrge_¬¿y
 *
	m£gm’t_h—d”_¬¿y
;

269 
u32
 
	mÄ_ÿches
;

270 
Ïrge_¬¿y
 *
	mhbË
;

271 
size_t
 
	mhtsize
;

272 
ht_h—d
 *
	mnuÎ_h—d
;

280 
u32
 
	m¿mbuf_poŞ_amouÁ
;

281 
u32
 
	mÄ_¿mbuf_poŞ
;

282 
¿mbufãr
 *
	m¿mbuf_poŞ
;

283 
mempoŞ_t
 *
	mæush_job_poŞ
;

291 
wÜkqueue_¡ruù
 *
	mæush”_wq
;

292 
wa™_queue_h—d_t
 
	mæush_wa™_queue
;

293 
©omic64_t
 
	mÏ¡_æushed_£gm’t_id
;

301 
wÜk_¡ruù
 
	mb¬r›r_d—dlše_wÜk
;

302 
tim”_li¡
 
	mb¬r›r_d—dlše_tim”
;

303 
bio_li¡
 
	mb¬r›r_ios
;

304 
	mb¬r›r_d—dlše_ms
;

312 
sk_¡ruù
 *
	mmig¿‹_d«mÚ
;

313 
	m®low_mig¿‹
;

314 
	murge_mig¿‹
;

315 
©omic64_t
 
	mÏ¡_mig¿‹d_£gm’t_id
;

320 
wa™_queue_h—d_t
 
	mmig¿‹_wa™_queue
;

321 
wa™_queue_h—d_t
 
	mwa™_drİ_ÿches
;

323 
wa™_queue_h—d_t
 
	mmig¿‹_io_wa™_queue
;

324 
©omic_t
 
	mmig¿‹_io_couÁ
;

325 
©omic_t
 
	mmig¿‹_ç_couÁ
;

327 
u32
 
	mÄ_cur_b©ched_mig¿tiÚ
;

328 
u32
 
	mÄ_max_b©ched_mig¿tiÚ
;

330 
u32
 
	mnum_emig¿‹s
;

331 
£gm’t_h—d”
 **
	memig¿‹s
;

332 *
	mmig¿‹_bufãr
;

333 
u8
 *
	mdœtšess_¢­shÙ
;

341 
sk_¡ruù
 *
	mmoduÏtÜ_d«mÚ
;

342 
	m’abË_mig¿tiÚ_moduÏtÜ
;

343 
u8
 
	mmig¿‹_th»shŞd
;

351 
sk_¡ruù
 *
	m»cÜd”_d«mÚ
;

352 
	mupd©e_»cÜd_š‹rv®
;

360 
sk_¡ruù
 *
	msync_d«mÚ
;

361 
	msync_š‹rv®
;

369 
©omic64_t
 
	mÄ_dœty_ÿches
;

370 
©omic64_t
 
	m¡©
[
STATLEN
];

371 
©omic64_t
 
	mcouÁ_nÚ_fuÎ_æushed
;

375 
	mæags
;

376 
boŞ
 
	mshould_em™_tuÇbËs
;

381 
acquœe_Ãw_£g
(
wb_deviû
 *, 
u64
 
id
);

382 
æush_cu¼’t_bufãr
(
wb_deviû
 *);

383 
šc_Ä_dœty_ÿches
(
wb_deviû
 *);

384 
ş—nup_mb_if_dœty
(
wb_deviû
 *, 
£gm’t_h—d”
 *, 
m‘ablock
 *);

385 
u8
 
»ad_mb_dœtšess
(
wb_deviû
 *, 
£gm’t_h—d”
 *, 
m‘ablock
 *);

386 
šv®id©e_´evious_ÿche
(
wb_deviû
 *, 
£gm’t_h—d”
 *,

387 
m‘ablock
 *
Şd_mb
, 
boŞ
 
ov”wr™e_fuÎsize
);

391 
wÜkqueue_¡ruù
 *
§ã_io_wq
;

392 
dm_io_ş›Á
 *
wb_io_ş›Á
;

398 
	#dm_§ã_io
(
io_»q
, 
num_»giÚs
, 
»giÚs
, 
”r_b™s
, 
th»ad
) \

399 
	`dm_§ã_io_š‹º®
(
wb
, (
io_»q
), (
num_»giÚs
), (
»giÚs
), \

400 (
”r_b™s
), (
th»ad
), 
__func__
);

	)

401 
dm_§ã_io_š‹º®
(
wb_deviû
 *, 
dm_io_»que¡
 *,

402 
num_»giÚs
, 
dm_io_»giÚ
 *,

403 *
”r_b™s
, 
boŞ
 
th»ad
, cÚ¡ *
ÿÎ”
);

405 
£ùÜ_t
 
dm_devsize
(
dm_dev
 *);

419 
	#LIVE_DEAD
(
´oc_live
, 
´oc_d—d
) \

421 ià(
	`lik–y
(!
	`‹¡_b™
(
WB_DEAD
, &
wb
->
æags
))) { \

422 
´oc_live
; \

424 
´oc_d—d
; \

426 } 0)

	)

428 
	#noİ_´oc
 dØ{} 0)

	)

429 
	#LIVE
(
´oc
è
	`LIVE_DEAD
Õroc, 
noİ_´oc
);

	)

430 
	#DEAD
(
´oc
è
	`LIVE_DEAD
(
noİ_´oc
,…roc);

	)

445 
	#IO
(
´oc
) \

447 
r
 = 0; \

448 
	`LIVE
(
r
 = 
´oc
); \

449 ià(
r
 =ğ-
EOPNOTSUPP
) { \

450 
r
 = 0; \

451 } ià(
r
 =ğ-
EIO
) { \

452 
	`£t_b™
(
WB_DEAD
, &
wb
->
æags
); \

453 
	`WBERR
("device is marked‡s dead"); \

454 } ià(
r
 =ğ-
ENOMEM
) { \

455 
	`WBERR
("I/O failed by ENOMEM"); \

456 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(1000));\

457 } ià(
r
) { \

458 
r
 = 0;\

459 
	`WARN_ONCE
(1, "PLEASE REPORT!!! I/O FAILED FOR UNKNOWN REASONƒ¼(%d)", 
r
); \

461 } 
r
)

	)

	@/usr/include/linux/sched.h

1 #iâdeà
_LINUX_SCHED_H


2 
	#_LINUX_SCHED_H


	)

7 
	#CSIGNAL
 0x000000fà

	)

8 
	#CLONE_VM
 0x00000100

	)

9 
	#CLONE_FS
 0x00000200

	)

10 
	#CLONE_FILES
 0x00000400

	)

11 
	#CLONE_SIGHAND
 0x00000800

	)

12 
	#CLONE_PTRACE
 0x00002000

	)

13 
	#CLONE_VFORK
 0x00004000

	)

14 
	#CLONE_PARENT
 0x00008000

	)

15 
	#CLONE_THREAD
 0x00010000

	)

16 
	#CLONE_NEWNS
 0x00020000

	)

17 
	#CLONE_SYSVSEM
 0x00040000

	)

18 
	#CLONE_SETTLS
 0x00080000

	)

19 
	#CLONE_PARENT_SETTID
 0x00100000

	)

20 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

21 
	#CLONE_DETACHED
 0x00400000

	)

22 
	#CLONE_UNTRACED
 0x00800000

	)

23 
	#CLONE_CHILD_SETTID
 0x01000000

	)

26 
	#CLONE_NEWUTS
 0x04000000

	)

27 
	#CLONE_NEWIPC
 0x08000000

	)

28 
	#CLONE_NEWUSER
 0x10000000

	)

29 
	#CLONE_NEWPID
 0x20000000

	)

30 
	#CLONE_NEWNET
 0x40000000

	)

31 
	#CLONE_IO
 0x80000000

	)

36 
	#SCHED_NORMAL
 0

	)

37 
	#SCHED_FIFO
 1

	)

38 
	#SCHED_RR
 2

	)

39 
	#SCHED_BATCH
 3

	)

41 
	#SCHED_IDLE
 5

	)

43 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 197166

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
è((×è<< 16è+ ((bè<< 8è+ (c))

	)

	@
1
.
1
/usr/include
8
191
dm-writeboost-daemon.c
dm-writeboost-daemon.h
dm-writeboost-metadata.c
dm-writeboost-metadata.h
dm-writeboost-target.c
dm-writeboost.h
/usr/include/linux/sched.h
/usr/include/linux/version.h
